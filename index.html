<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NAVgator — Treasury Analytics for Ownership Tokens</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@300;400;500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════════════════ */
/* DESIGN TOKENS                                                   */
/* ═══════════════════════════════════════════════════════════════ */
:root {
  /* Surface */
  --bg:        #080a0c;
  --bg2:       #0d1014;
  --bg3:       #111519;
  --bg4:       #161b20;
  /* Borders */
  --bdr:       #1c2228;
  --bdr2:      #232b33;
  --bdr3:      #2a343e;
  /* Text */
  --dim:       #3d4d5c;
  --muted:     #5e7180;
  --body:      #8ba0b2;
  --bright:    #c8d8e4;
  --white:     #edf2f6;
  /* Brand */
  --green:     #00e5a0;
  --green-dim: rgba(0,229,160,0.08);
  --green-glow:rgba(0,229,160,0.18);
  --red:       #f04060;
  --orange:    #f5a742;
  --blue:      #4d8fff;
  --purple:    #a48ffc;
  /* Chart */
  --chart-bg:  #080a0c;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Inter', -apple-system, system-ui, sans-serif;
  background: var(--bg);
  color: var(--body);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}
::selection { background: rgba(0,229,160,0.2); color: var(--white); }

/* ── Scrollbar ── */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: var(--bg2); }
::-webkit-scrollbar-thumb { background: var(--bdr3); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--muted); }

/* ═══════════════════════════════════════════════════════════════ */
/* LAYOUT                                                          */
/* ═══════════════════════════════════════════════════════════════ */
/* ═══════════════════════════════════════════════════════════════ */
/* APP SHELL — DexScreener-style full-height sidebar layout        */
/* ═══════════════════════════════════════════════════════════════ */

/* Kill the old wrap padding — shell is full-bleed */
.wrap { max-width: none; margin: 0; padding: 0; }

/* App shell: sidebar left, content right */
.app-shell {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ── Left sidebar — brand + token list ── */
.app-left {
  width: 220px;
  flex-shrink: 0;
  background: var(--bg);
  border-right: 1px solid var(--bdr);
  display: none;  /* hidden by default; JS adds .token-mode to show */
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
  position: relative;
  z-index: 50;
}
.app-left.token-mode {
  display: flex;
}

/* Brand area at top of left rail */
.app-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 14px;
  height: 68px;
  border-bottom: 1px solid var(--bdr);
  text-decoration: none;
  flex-shrink: 0;
  box-sizing: border-box;
}
.app-brand-mark {
  width: 26px; height: 26px;
  background: var(--green);
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Syne', sans-serif;
  font-size: 13px; font-weight: 800;
  color: #050807;
  letter-spacing: -0.5px;
  flex-shrink: 0;
}
.app-brand-text {
  font-family: 'Syne', sans-serif;
  font-size: 16px; font-weight: 700;
  color: var(--white); letter-spacing: -0.3px;
}
.app-brand-text span { color: var(--green); }

/* Token list lives in the left rail */
.app-token-list {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ── Right area — topbar + content ── */
.app-right {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

/* ── Single unified topnav — same on all pages ── */
.topnav {
  display: flex;
  align-items: center;
  padding: 0 20px 0 0;
  height: 44px;
  border-bottom: 1px solid var(--bdr);
  background: var(--bg);
  flex-shrink: 0;
  gap: 0;
}

/* Left anchor: on token pages this is empty (sidebar has the brand);
   on landing it shows the brand — both are exactly 220px wide so
   nav links land at the same X position on every page. */
.nav-brand {
  width: 220px;
  flex-shrink: 0;
  display: flex; align-items: center; gap: 10px;
  padding: 0 14px;
  text-decoration: none;
  border-right: 1px solid var(--bdr);
  height: 100%;
  box-sizing: border-box;
}
/* On token pages: brand is in sidebar — collapse the topnav anchor to 0 */
body.is-token .topnav .nav-brand {
  display: none;
}
/* Landing/compare: topnav sticks at top */
body:not(.is-token) .topnav {
  position: sticky;
  top: 0;
  z-index: 80;
}
/* Token pages: topnav scrolls away — token-header below is sticky */
body.is-token .topnav {
  position: static;
}
.nav-brand-mark {
  width: 26px; height: 26px;
  background: var(--green); border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 800;
  color: #050807; letter-spacing: -0.5px; flex-shrink: 0;
}
.nav-brand-text {
  font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700;
  color: var(--white); letter-spacing: -0.3px;
}
.nav-brand-text span { color: var(--green); }
.topnav .nav-center {
  flex: 1; display: flex; gap: 2px; align-items: center; padding: 0 12px;
}
.nav-link {
  font-family: 'Inter', sans-serif;
  font-size: 12px; font-weight: 500;
  color: var(--muted);
  text-decoration: none;
  padding: 5px 12px;
  border-radius: 6px;
  transition: color 0.15s, background 0.15s;
}
.nav-link:hover { color: var(--white); background: var(--bg3); }
.nav-link.nav-active { color: var(--white); font-weight: 600; }
.nav-right { display: flex; align-items: center; gap: 8px; padding-right: 20px; }
.nav-btn-outline {
  font-family: 'Inter', sans-serif;
  font-size: 11px; font-weight: 600;
  color: var(--green);
  text-decoration: none;
  padding: 5px 12px;
  border: 1px solid rgba(0,229,160,0.3);
  border-radius: 16px;
  transition: all 0.15s;
}
.nav-btn-outline:hover { background: var(--green-dim); border-color: var(--green); }
.nav-btn-solid {
  font-family: 'Inter', sans-serif;
  font-size: 11px; font-weight: 600;
  color: #050807; background: var(--green);
  text-decoration: none;
  padding: 5px 14px;
  border-radius: 16px;
  transition: opacity 0.15s;
}
.nav-btn-solid:hover { opacity: 0.88; }

/* Content area scrolls within the right panel */
.app-content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: thin;
  scrollbar-color: var(--bdr3) transparent;
}
.app-content::-webkit-scrollbar { width: 4px; }
.app-content::-webkit-scrollbar-track { background: transparent; }
.app-content::-webkit-scrollbar-thumb { background: var(--bdr3); border-radius: 2px; }

/* Views */
.landing  { display: none; }
.landing.active  { display: block; }
.dashboard { display: none; }
.dashboard.active { display: block; }
.compare  { display: none; }
.compare.active  { display: block; }

/* Landing/compare get internal padding */
.landing, .compare { padding: 0 32px 80px; }

/* ═══════════════════════════════════════════════════════════════ */
/* LANDING — HERO STATS STRIP                                      */
/* ═══════════════════════════════════════════════════════════════ */
.hero-strip {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 24px 0 20px;
  border-bottom: 1px solid var(--bdr);
  gap: 24px;
  flex-wrap: wrap;
}
.hero-title-block {}
.hero-title {
  font-family: 'Syne', sans-serif;
  font-size: 26px;
  font-weight: 700;
  color: var(--white);
  letter-spacing: -0.5px;
  line-height: 1.2;
}
.hero-sub {
  font-size: 13px;
  color: var(--muted);
  margin-top: 4px;
  letter-spacing: 0.1px;
}
.hero-stats { display: flex; gap: 32px; }
.hs-item { text-align: right; }
.hs-label {
  font-size: 9px; font-weight: 600;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 3px;
}
.hs-val {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 18px; font-weight: 500;
  color: var(--green);
}

/* ═══════════════════════════════════════════════════════════════ */
/* FILTER BAR                                                      */
/* ═══════════════════════════════════════════════════════════════ */
.filter-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  gap: 8px;
}
.filter-tabs { display: flex; gap: 4px; }
.ftab {
  font-size: 12px; font-weight: 500;
  color: var(--muted);
  padding: 5px 12px;
  border-radius: 6px;
  cursor: pointer;
  border: 1px solid transparent;
  transition: all 0.15s;
  background: none;
  font-family: 'Inter', sans-serif;
}
.ftab:hover { color: var(--white); }
.ftab.active {
  color: var(--white);
  background: var(--bg3);
  border-color: var(--bdr2);
}
.filter-right { display: flex; align-items: center; gap: 6px; }
.filter-search {
  font-family: 'Inter', sans-serif;
  font-size: 12px;
  padding: 6px 12px;
  border-radius: 7px;
  border: 1px solid var(--bdr);
  background: var(--bg2);
  color: var(--white);
  outline: none;
  width: 180px;
  transition: border-color 0.15s, width 0.2s;
}
.filter-search:focus { border-color: var(--green); width: 220px; }
.filter-search::placeholder { color: var(--dim); }

/* ═══════════════════════════════════════════════════════════════ */
/* TOKEN TABLE                                                     */
/* ═══════════════════════════════════════════════════════════════ */
.token-table-wrap { margin: 0; }
.token-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 3px;
  font-family: 'Inter', sans-serif;
}

.token-table thead th {
  font-size: 9px;
  font-weight: 600;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 8px 16px;
  text-align: right;
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
}
.token-table thead th:nth-child(1),
.token-table thead th:nth-child(2) { text-align: center; }
.token-table thead th:nth-child(3) { text-align: left; }
.token-table thead th:hover:not(.no-sort) { color: var(--green); }
.token-table thead th.sorted { color: var(--green); }

.token-table tbody tr {
  cursor: pointer;
  transition: all 0.18s;
  position: relative;
}
.token-table tbody td {
  padding: 14px 16px;
  background: var(--bg2);
  border-top: 1px solid var(--bdr);
  border-bottom: 1px solid var(--bdr);
  font-size: 13px;
  color: var(--body);
  text-align: right;
  white-space: nowrap;
  vertical-align: middle;
  transition: background 0.18s;
}
.token-table tbody td:first-child {
  border-left: 1px solid var(--bdr);
  border-radius: 8px 0 0 8px;
  text-align: center;
  width: 36px;
  padding: 14px 8px;
}
.token-table tbody td:nth-child(2) {
  text-align: center;
  color: var(--dim);
  font-size: 11px;
  font-weight: 500;
  padding-left: 4px; padding-right: 4px;
}
.token-table tbody td:nth-child(3) { text-align: left; }
.token-table tbody td:last-child {
  border-right: 1px solid var(--bdr);
  border-radius: 0 8px 8px 0;
}

.token-table tbody tr:hover td {
  background: var(--bg3);
  border-color: var(--bdr2);
}
.token-table tbody tr:hover td:first-child {
  border-left-color: var(--green);
}

/* Name cell */
.tt-name-cell { display: flex; align-items: center; gap: 12px; }
.tt-icon {
  width: 34px; height: 34px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
}
.tt-icon img { width: 100%; height: 100%; object-fit: cover; }
.tt-name { font-weight: 600; color: var(--white); font-size: 14px; }
.tt-ticker { color: var(--dim); font-size: 10px; margin-top: 1px; letter-spacing: 0.5px; text-transform: uppercase; }

/* Price cell */
.tt-price {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 13px; font-weight: 400;
  color: var(--bright);
}
.tt-change { font-size: 10px; margin-top: 3px; }
.tt-change.up { color: var(--green); }
.tt-change.down { color: var(--red); }

/* NAV badge */
.tt-nav-val {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 13px; color: var(--body);
}

/* P/NAV badge */
.pnav-badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 5px;
  font-size: 11px;
  font-weight: 600;
  font-family: 'IBM Plex Mono', monospace;
}
.pnav-badge.above { background: rgba(0,229,160,0.1); color: var(--green); }
.pnav-badge.below { background: rgba(240,64,96,0.1); color: var(--red); }
.pnav-badge.neutral { background: var(--bg3); color: var(--muted); }

/* Launchpad pill */
.lp-badge {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 10px; font-weight: 600;
  padding: 3px 8px;
  border-radius: 20px;
  white-space: nowrap;
  border: 1px solid transparent;
  transition: all 0.15s;
}
.lp-badge.metadao {
  background: rgba(124, 58, 237, 0.08);
  color: #a78bfa;
  border-color: rgba(124, 58, 237, 0.15);
}
.lp-badge.metadao::before {
  content: '';
  width: 5px; height: 5px;
  border-radius: 50%;
  background: #a78bfa;
  flex-shrink: 0;
}
.lp-badge.unknown {
  background: var(--bg3); color: var(--muted);
  border-color: var(--bdr2);
}

/* Treasury */
.tt-treasury {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 13px; color: var(--green);
}

/* Mcap */
.tt-mcap { font-family: 'IBM Plex Mono', monospace; font-size: 13px; }

/* Sparkline */
.tt-sparkline { width: 180px; height: 44px; }
.spark-container { width: 180px; height: 44px; }

/* Star */
.wl-star {
  color: var(--dim);
  cursor: pointer;
  transition: color 0.15s;
  display: inline-flex; align-items: center; justify-content: center;
}
.wl-star:hover, .wl-star.active { color: var(--green); }

.tt-coming {
  font-size: 9px; font-weight: 600;
  color: var(--dim);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

/* ═══════════════════════════════════════════════════════════════ */
/* DASHBOARD — TOKEN PAGE v4                                       */
/* ═══════════════════════════════════════════════════════════════ */

/* Dashboard fills the app-right content area */
.dashboard { margin: 0; }
.dash-body  { display: flex; flex-direction: column; min-height: 100%; }

/* ═══════════════════════════════════════════════════════════════
   TOKEN LIST — lives inside app-left shell
   ═══════════════════════════════════════════════════════════════ */
/* app-left is styled in the LAYOUT section above */
.app-token-list {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
/* Keep .token-panel as alias in case JS references it */
#token-left-panel { display: contents; }
.tp-topbar { padding: 10px 10px 8px; border-bottom: 1px solid var(--bdr); flex-shrink: 0; }
.tp-topbar-label { font-size: 7px; font-weight: 800; color: var(--dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 7px; display: flex; align-items: center; justify-content: space-between; }
.tp-section-count { background: var(--bg3); border: 1px solid var(--bdr); border-radius: 8px; padding: 1px 5px; color: var(--muted); font-size: 8px; line-height: 1.5; }
.tp-search-wrap { position: relative; }
.tp-search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: var(--dim); font-size: 11px; pointer-events: none; }
.tp-search { width: 100%; font-family: 'Inter', sans-serif; font-size: 11px; padding: 5px 8px 5px 26px; border-radius: 5px; border: 1px solid var(--bdr); background: var(--bg2); color: var(--white); outline: none; transition: border-color 0.15s; }
.tp-search:focus { border-color: var(--green); }
.tp-search::placeholder { color: var(--dim); }
.tp-scroll { flex: 1; overflow-y: auto; scrollbar-width: none; }
.tp-scroll::-webkit-scrollbar { display: none; }
.tp-section-label { font-size: 7px; font-weight: 800; color: var(--dim); text-transform: uppercase; letter-spacing: 2px; padding: 9px 10px 3px; display: flex; align-items: center; gap: 5px; }
.tp-wl-section { border-bottom: 1px solid var(--bdr); padding-bottom: 2px; }
.tp-item { display: flex; align-items: center; padding: 7px 10px; text-decoration: none; position: relative; transition: background 0.1s; gap: 8px; border-bottom: 1px solid rgba(255,255,255,0.02); }
.tp-item:hover { background: rgba(255,255,255,0.025); }
.tp-item.active { background: rgba(0,229,160,0.04); }
.tp-item.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--green); }
.tp-icon { width: 26px; height: 26px; border-radius: 50%; overflow: hidden; flex-shrink: 0; border: 1px solid var(--bdr); display: flex; align-items: center; justify-content: center; background: var(--bg3); }
.tp-icon img { width: 100%; height: 100%; object-fit: cover; }
.tp-info { flex: 1; min-width: 0; }
.tp-name { font-size: 11px; font-weight: 600; color: var(--bright); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
.tp-item.active .tp-name { color: var(--white); }
.tp-fullname { font-size: 9px; color: var(--dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }
.tp-right { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; flex-shrink: 0; }
.tp-price { font-family: 'IBM Plex Mono', monospace; font-size: 9px; color: var(--body); white-space: nowrap; }
.tp-pnav { font-size: 8px; font-weight: 700; padding: 1px 4px; border-radius: 3px; font-family: 'IBM Plex Mono', monospace; }
.tp-pnav.above { background: rgba(0,229,160,0.1); color: var(--green); }
.tp-pnav.below { background: rgba(240,64,96,0.1); color: var(--red); }
.tp-pnav.none { color: var(--dim); }
.tp-wl-section { border-bottom: 1px solid var(--bdr); padding-bottom: 2px; }
.tp-footer { padding: 8px 10px; border-top: 1px solid var(--bdr); flex-shrink: 0; }
.tp-footer a { font-size: 10px; color: var(--dim); text-decoration: none; transition: color 0.15s; }
.tp-footer a:hover { color: var(--muted); }

/* ═══════════════════════════════════════════════════════════════
   MAIN COLUMN
   ═══════════════════════════════════════════════════════════════ */
.dash-main { flex: 1; min-width: 0; display: flex; flex-direction: column; width: 100%; }

/* ═══════════════════════════════════════════════════════════════
   HEADER — token identity + live price side by side
   ═══════════════════════════════════════════════════════════════ */
.token-header {
  display: flex; align-items: center;
  padding: 0 24px; gap: 20px;
  height: 68px;
  border-bottom: 1px solid var(--bdr);
  flex-shrink: 0; flex-wrap: wrap;
  position: sticky;
  top: 0;
  z-index: 40;
  background: var(--bg);
}
.th-left  { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
.th-icon  { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; flex-shrink: 0; outline: 2px solid var(--bdr2); outline-offset: 1px; }
.th-icon img { width: 100%; height: 100%; object-fit: cover; display: block; }
.th-name  { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 700; color: var(--white); letter-spacing: -0.5px; line-height: 1; }
.th-meta  { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
.th-ticker { font-size: 9px; font-weight: 700; color: var(--dim); letter-spacing: 2px; text-transform: uppercase; }
.th-dot   { width: 2px; height: 2px; border-radius: 50%; background: var(--bdr3); }
.th-live-pill { display: flex; align-items: center; gap: 4px; font-size: 9px; font-weight: 700; color: var(--green); }
.th-live-dot  { width: 5px; height: 5px; border-radius: 50%; background: var(--green); flex-shrink: 0; animation: livePulse 2s ease-in-out infinite; }
@keyframes livePulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(0,229,160,0.6); }
  50%      { box-shadow: 0 0 0 4px rgba(0,229,160,0); }
}

/* Price + badges — right side of header */
.th-right { display: flex; align-items: center; gap: 14px; flex-shrink: 0; }
.th-price {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 30px; font-weight: 300;
  color: var(--white); letter-spacing: -1.5px; line-height: 1;
}
.th-badges { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
#price-hero-pct {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px; font-weight: 600;
  padding: 2px 8px; border-radius: 4px;
}
.th-price-change {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; font-weight: 600;
  padding: 2px 8px; border-radius: 4px;
}
.th-price-change.up   { background: rgba(0,229,160,0.1); color: var(--green); }
.th-price-change.down { background: rgba(240,64,96,0.1);  color: var(--red); }

/* Kill legacy */
.th-price-meta { display: none !important; }
.metrics-strip  { display: none !important; }
.params-bar     { display: none !important; }

/* ═══════════════════════════════════════════════════════════════
   SNAPSHOT BAR — 4 key numbers below header, full width
   ═══════════════════════════════════════════════════════════════ */
.snap-bar {
  display: grid;
  grid-template-columns: 1fr 1fr 1.15fr 1fr;
  border-bottom: 1px solid var(--bdr);
  flex-shrink: 0;
}
.snap-cell {
  padding: 10px 20px 10px 24px;
  border-right: 1px solid var(--bdr);
}
.snap-cell:last-child { border-right: none; }
.snap-label { font-size: 8px; font-weight: 700; color: var(--dim); text-transform: uppercase; letter-spacing: 1.8px; margin-bottom: 4px; }
.snap-value {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 15px; font-weight: 300;
  color: var(--bright); letter-spacing: -0.3px; line-height: 1;
}
.snap-sub { font-size: 9px; color: var(--dim); margin-top: 2px; }
/* P/NAV gets emphasis */
.snap-cell.pnav { background: var(--bg2); }
.snap-cell.pnav .snap-value { font-size: 19px; font-weight: 400; }
.snap-cell.pnav .snap-value.above { color: var(--green); }
.snap-cell.pnav .snap-value.below { color: var(--red); }

/* ═══════════════════════════════════════════════════════════════
   CONTENT BODY — chart col + data panel
   ═══════════════════════════════════════════════════════════════ */
.token-body {
  display: grid;
  grid-template-columns: 1fr 228px;
  flex: 1;
}
.token-chart-col {
  min-width: 0;
  border-right: 1px solid var(--bdr);
  display: flex; flex-direction: column;
}
.token-stats-col {
  background: var(--bg);
  overflow-y: auto; scrollbar-width: none;
  position: sticky; top: 0;
  max-height: 100vh;
}
.token-stats-col::-webkit-scrollbar { display: none; }

/* ═══════════════════════════════════════════════════════════════
   CHART
   ═══════════════════════════════════════════════════════════════ */
.chart-section { flex: 1; display: flex; flex-direction: column; }
.chart-topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 16px 8px 24px;
  border-bottom: 1px solid var(--bdr);
  gap: 8px; flex-wrap: wrap; flex-shrink: 0;
}
.chart-label { font-size: 8px; font-weight: 700; color: var(--dim); text-transform: uppercase; letter-spacing: 2px; }
.chart-controls { display: flex; gap: 1px; align-items: center; }
.chart-controls + .chart-controls { margin-left: 6px; padding-left: 8px; border-left: 1px solid var(--bdr); }
.cbtn {
  font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 500;
  padding: 3px 9px; border-radius: 4px; border: none;
  background: transparent; color: var(--dim); cursor: pointer; transition: all 0.1s;
}
.cbtn:hover { color: var(--bright); background: var(--bg3); }
.cbtn.active { color: var(--green); background: rgba(0,229,160,0.08); }
.chart-body { flex: 1; padding: 12px 8px 0; min-height: 300px; position: relative; }
#chart-container { width: 100%; height: 100%; min-height: 300px; position: relative; cursor: default; }
#chart-canvas { display: block; }
.chart-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 11px; color: var(--dim); font-family: 'IBM Plex Mono', monospace; }
.chart-legend { display: flex; gap: 14px; padding: 6px 16px 10px 24px; font-size: 9px; color: var(--dim); flex-shrink: 0; }
.leg-item { display: flex; align-items: center; gap: 5px; }
.leg-line { width: 14px; height: 2px; border-radius: 1px; }
.leg-dash { width: 14px; height: 2px; background: repeating-linear-gradient(to right, rgba(255,255,255,0.35) 0, rgba(255,255,255,0.35) 3px, transparent 3px, transparent 6px); }
.leg-fill { width: 10px; height: 8px; border-radius: 2px; }

/* Tooltip */
.chart-tooltip {
  position: absolute; display: none; pointer-events: none;
  background: rgba(5,7,9,0.97); border: 1px solid var(--bdr2);
  border-radius: 8px; padding: 10px 14px; z-index: 20;
  backdrop-filter: blur(16px); box-shadow: 0 8px 32px rgba(0,0,0,0.7);
  min-width: 148px;
}
.tt-date { font-size: 8px; color: var(--dim); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
.tt-row  { display: flex; justify-content: space-between; gap: 14px; margin-bottom: 2px; }
.tt-key  { font-size: 10px; color: var(--muted); }
.tt-v    { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--bright); }

/* ═══════════════════════════════════════════════════════════════
   NAV HISTORY (rendered by JS into #nav-stats-outer)
   ═══════════════════════════════════════════════════════════════ */
.nav-stats-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid var(--bdr); flex-shrink: 0; }
.ns-item { padding: 10px 20px 10px 24px; border-right: 1px solid var(--bdr); }
.ns-item:last-child { border-right: none; }
.ns-label { font-size: 7px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: var(--dim); margin-bottom: 3px; }
.ns-value { font-family: 'IBM Plex Mono', monospace; font-size: 14px; }
.ns-sub { font-size: 9px; color: var(--dim); margin-top: 1px; }
.ns-progress { height: 2px; border-radius: 1px; margin-top: 6px; background: rgba(255,255,255,0.05); overflow: hidden; }
.ns-progress-fill { height: 100%; border-radius: 1px; }
.ns-above { color: var(--green); }
.ns-below { color: var(--red); }
.ns-neutral { color: var(--muted); }

/* ═══════════════════════════════════════════════════════════════
   BOTTOM SECTIONS — addresses, allowance
   ═══════════════════════════════════════════════════════════════ */
.section-block { border-top: 1px solid var(--bdr); flex-shrink: 0; }
.sb-header { display: flex; align-items: center; justify-content: space-between; padding: 9px 24px; border-bottom: 1px solid var(--bdr); }
.sb-title { font-size: 8px; font-weight: 800; color: var(--dim); text-transform: uppercase; letter-spacing: 2px; }
.sb-sub   { font-size: 10px; color: var(--dim); }
.addr-inner { padding: 0 24px; }
.addr-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); gap: 12px; }
.addr-row:last-child { border-bottom: none; }
.addr-label { color: var(--muted); font-weight: 500; min-width: 120px; font-size: 11px; flex-shrink: 0; }
.addr-val { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; }
.addr-val a { color: var(--body); text-decoration: none; font-family: 'IBM Plex Mono', monospace; font-size: 10px; transition: color 0.15s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.addr-val a:hover { color: var(--green); }
.addr-copy { background: none; border: 1px solid var(--bdr); border-radius: 3px; color: var(--dim); font-size: 9px; padding: 1px 5px; cursor: pointer; transition: all 0.15s; font-family: 'Inter', sans-serif; flex-shrink: 0; }
.addr-copy:hover, .addr-copy.copied { border-color: var(--green); color: var(--green); }
.addr-bals { margin-left: auto; font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--muted); display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
.bal-sep { color: var(--bdr2); }
.allowance-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); }
.allowance-card { padding: 12px 20px; border-right: 1px solid var(--bdr); border-top: 1px solid var(--bdr); }
.allowance-card:last-child { border-right: none; }
.ac-label { font-size: 7px; font-weight: 800; color: var(--dim); text-transform: uppercase; letter-spacing: 1.8px; margin-bottom: 4px; }
.ac-value { font-family: 'IBM Plex Mono', monospace; font-size: 15px; font-weight: 300; color: var(--bright); }
.ac-sub   { font-size: 9px; color: var(--dim); margin-top: 2px; }
.util-bar { height: 2px; border-radius: 1px; background: var(--bdr); margin-top: 6px; overflow: hidden; }
.util-fill { height: 100%; border-radius: 1px; }
.allowance-history { padding: 10px 24px; border-top: 1px solid var(--bdr); }
.allowance-month { display: inline-flex; align-items: center; gap: 8px; padding: 2px 0; margin-right: 14px; }
.am-label { color: var(--muted); font-size: 9px; min-width: 44px; font-family: 'IBM Plex Mono', monospace; }
.am-bar   { width: 44px; height: 2px; background: var(--bdr); display: inline-block; position: relative; border-radius: 1px; }
.am-fill  { height: 100%; border-radius: 1px; position: absolute; left: 0; top: 0; }
.am-pct   { color: var(--body); font-size: 9px; min-width: 30px; text-align: right; font-family: 'IBM Plex Mono', monospace; }

/* ═══════════════════════════════════════════════════════════════
   RIGHT DATA PANEL — NAV hero + seamless rows, no card chrome
   ═══════════════════════════════════════════════════════════════ */

/* NAV hero at top of panel */
.dp-nav {
  padding: 16px 16px 14px;
  border-bottom: 1px solid var(--bdr);
  position: relative;
}
.dp-nav::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, var(--green) 0%, transparent 100%);
}
.dp-nav-eyebrow { font-size: 7px; font-weight: 800; color: var(--dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
.dp-nav-val {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 30px; font-weight: 300;
  color: var(--white); letter-spacing: -1.5px; line-height: 1;
}
.dp-nav-sub { font-size: 9px; color: var(--dim); margin-top: 3px; margin-bottom: 12px; line-height: 1.4; }
.dp-nav-badge {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 11px; border-radius: 6px;
  font-family: 'IBM Plex Mono', monospace; font-size: 14px; font-weight: 600;
}
.dp-nav-badge.above { background: rgba(0,229,160,0.07); color: var(--green); border: 1px solid rgba(0,229,160,0.15); }
.dp-nav-badge.below { background: rgba(240,64,96,0.07);  color: var(--red);   border: 1px solid rgba(240,64,96,0.15); }
.dp-nav-badge-lbl { font-size: 9px; font-weight: 400; font-family: 'Inter', sans-serif; opacity: 0.7; }

/* Treasury section */
.dp-treasury {
  padding: 12px 16px;
  border-bottom: 1px solid var(--bdr);
}
.dp-sec-label { font-size: 7px; font-weight: 800; color: var(--dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
.dp-treas-total {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 18px; font-weight: 300;
  color: var(--green); letter-spacing: -0.5px; margin-bottom: 8px;
}
.dp-tbar { height: 3px; border-radius: 2px; background: var(--bdr); overflow: hidden; display: flex; margin-bottom: 8px; }
.dp-tbar-seg { height: 100%; }
.dp-trows { display: flex; flex-direction: column; gap: 4px; }
.dp-trow { display: flex; align-items: center; justify-content: space-between; font-size: 10px; }
.dp-trow-left { display: flex; align-items: center; gap: 6px; color: var(--muted); }
.dp-tdot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
.dp-trow-right { font-family: 'IBM Plex Mono', monospace; color: var(--body); font-size: 10px; }

/* Data rows — shared for valuation / health / performance */
.dp-group { border-bottom: 1px solid var(--bdr); }
.dp-group-label { font-size: 7px; font-weight: 800; color: var(--dim); text-transform: uppercase; letter-spacing: 2px; padding: 9px 16px 4px; }
.dp-row { display: flex; align-items: center; justify-content: space-between; padding: 4px 16px; }
.dp-row:last-child { padding-bottom: 10px; }
.dp-key { font-size: 11px; color: var(--muted); }
.dp-val { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--bright); text-align: right; }
.dp-val.green  { color: var(--green); }
.dp-val.red    { color: var(--red); }
.dp-val.orange { color: var(--orange); }
.dp-val.dim    { color: var(--dim); }


/* ═══════════════════════════════════════════════════════════════ */
/* COMPARE VIEW                                                    */
/* ═══════════════════════════════════════════════════════════════ */
.compare-wrap { max-width: 960px; margin: 0 auto; padding: 32px 0; }
.compare-header { display: flex; align-items: center; gap: 14px; margin-bottom: 32px; }
.compare-back {
  width: 36px; height: 36px;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--bdr2);
  border-radius: 8px;
  color: var(--muted);
  text-decoration: none;
  transition: all 0.15s;
  font-size: 18px;
}
.compare-back:hover { color: var(--white); border-color: var(--green); }
.compare-title {
  font-family: 'Syne', sans-serif;
  font-size: 22px; font-weight: 700;
  color: var(--white);
  letter-spacing: -0.3px;
}
.compare-selectors { display: flex; align-items: center; gap: 12px; justify-content: center; margin-bottom: 14px; }
.compare-select {
  font-family: 'Inter', sans-serif;
  font-size: 13px; padding: 10px 16px;
  border-radius: 10px; border: 1px solid var(--bdr2);
  background: var(--bg2); color: var(--white);
  min-width: 200px; cursor: pointer;
  appearance: auto; outline: none;
  transition: border-color 0.15s;
}
.compare-select:focus { border-color: var(--green); }
.compare-swap {
  font-size: 18px; color: var(--muted);
  cursor: pointer; padding: 8px;
  border: 1px solid var(--bdr2); border-radius: 8px;
  transition: all 0.15s; user-select: none;
}
.compare-swap:hover { color: var(--white); border-color: var(--green); }
.compare-quick { display: flex; gap: 8px; justify-content: center; margin-bottom: 32px; flex-wrap: wrap; }
.compare-quick-btn {
  font-family: 'Inter', sans-serif;
  font-size: 11px; padding: 5px 12px;
  border-radius: 20px; border: 1px solid var(--bdr2);
  background: transparent; color: var(--muted);
  cursor: pointer; transition: all 0.15s;
}
.compare-quick-btn:hover { color: var(--white); border-color: var(--green); }
.compare-placeholder { text-align: center; color: var(--dim); font-size: 13px; padding: 64px 0; }
.compare-card {
  background: var(--bg2); border: 1px solid var(--bdr2);
  border-radius: 12px; padding: 28px 32px; margin-bottom: 16px;
}
.compare-card-label {
  font-size: 10px; font-weight: 600;
  color: var(--dim); text-transform: uppercase;
  letter-spacing: 1px; margin-bottom: 20px;
  text-align: center;
}
.compare-bar-wrap { margin: 10px 0; }
.compare-bar {
  height: 6px; border-radius: 3px;
  overflow: hidden;
  display: flex;
  background: var(--bdr);
  margin-bottom: 6px;
}
.compare-bar-a { height: 100%; }
.compare-bar-b { height: 100%; }
.compare-bar-labels {
  display: flex; justify-content: space-between;
  font-size: 11px; font-weight: 600;
  font-family: 'IBM Plex Mono', monospace;
}
.compare-bar-note { font-size: 10px; color: var(--dim); margin-top: 3px; }
.compare-perf-row {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--bdr);
}
.compare-perf-row:last-child { border-bottom: none; }
.compare-perf-left, .compare-perf-right {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 14px; font-weight: 400;
  min-width: 80px;
}
.compare-perf-right { text-align: right; }
.compare-perf-center { flex: 1; text-align: center; font-size: 11px; color: var(--muted); }
.compare-hero-row { display: flex; gap: 0; margin-bottom: 24px; }
.compare-col {
  flex: 1;
  padding: 20px 24px;
  border: 1px solid var(--bdr2);
  background: var(--bg3);
}
.compare-col:first-child { border-radius: 10px 0 0 10px; border-right: none; }
.compare-col:last-child { border-radius: 0 10px 10px 0; }
.cc-token { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
.cc-icon { width: 32px; height: 32px; border-radius: 50%; overflow: hidden; }
.cc-icon img { width: 100%; height: 100%; object-fit: cover; }
.cc-name { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; color: var(--white); }
.cc-stat { margin-top: 6px; }
.cc-stat-label { font-size: 9px; color: var(--dim); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 2px; }
.cc-stat-val { font-family: 'IBM Plex Mono', monospace; font-size: 18px; color: var(--bright); }

/* ═══════════════════════════════════════════════════════════════ */
/* FOOTER                                                          */
/* ═══════════════════════════════════════════════════════════════ */
.footer {
  font-size: 10px; color: var(--dim);
  text-align: center;
  padding: 24px 0;
  border-top: 1px solid var(--bdr);
  margin-top: 8px;
}
.footer a { color: var(--muted); text-decoration: underline; }
.footer a:hover { color: var(--body); }

/* ═══════════════════════════════════════════════════════════════ */
/* RESPONSIVE                                                      */
/* ═══════════════════════════════════════════════════════════════ */
/* Sidebar visibility controlled above in base .app-left rule      */

@media (max-width: 1024px) {
  /* Shrink sidebar slightly on smaller desktops */
  .app-left.token-mode { width: 180px; }
}
@media (max-width: 900px) {
  /* Stack layout on tablet/mobile */
  .app-shell { flex-direction: column; height: auto; overflow: visible; }
  .app-left.token-mode { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--bdr); flex-direction: row; overflow: hidden; }
  .app-brand { border-bottom: none; border-right: 1px solid var(--bdr); padding: 10px 14px; flex-shrink: 0; }
  .app-token-list { flex-direction: row; overflow: hidden; }
  .tp-topbar { display: none; }
  .tp-scroll { flex-direction: row; max-height: 52px; }
  .tp-scroll #tlp-wl-section, .tp-scroll .tp-section-label { display: none; }
  .tp-scroll #tlp-all-list { display: flex; overflow-x: auto; scrollbar-width: none; padding: 0 4px; }
  .tp-scroll #tlp-all-list::-webkit-scrollbar { display: none; }
  .tp-item { flex-direction: column; align-items: center; padding: 6px 8px; gap: 2px; min-width: 52px; border-bottom: none; }
  .tp-item.active::before { top: auto; bottom: 0; left: 0; right: 0; width: 100%; height: 2px; }
  .tp-info { display: none; }
  .tp-right { display: none; }
  .tp-footer { display: none; }
  .app-right { height: auto; overflow: visible; }
  .app-content { overflow: visible; }
  .nav-center { display: none; }
  .snap-bar { grid-template-columns: 1fr 1fr; }
  .snap-cell:nth-child(2) { border-right: none; }
  .snap-cell.pnav { border-top: 1px solid var(--bdr); }
  .snap-cell:last-child { border-right: none; }
  .token-body { grid-template-columns: 1fr; }
  .token-stats-col { position: static; max-height: none; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
  .token-table td:nth-child(7), .token-table th:nth-child(7) { display: none; }
}
@media (max-width: 768px) {
  .hero-stats { display: none; }
  .token-table td:nth-child(6), .token-table th:nth-child(6),
  .token-table td:nth-child(8), .token-table th:nth-child(8) { display: none; }
  .spark-container { width: 120px; }
  .tt-sparkline { width: 120px; }
}
@media (max-width: 680px) {
  .token-table td:nth-child(9), .token-table th:nth-child(9) { display: none; }
}
@media (max-width: 560px) {
  .token-table td:nth-child(4), .token-table th:nth-child(4),
  .token-table td:nth-child(5), .token-table th:nth-child(5) { display: none; }
  .landing, .compare { padding: 0 16px 60px; }
}

/* ═══════════════════════════════════════════════════════════════ */
/* ANIMATIONS                                                      */
/* ═══════════════════════════════════════════════════════════════ */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}
.token-table tbody tr {
  animation: fadeIn 0.3s ease both;
}
.token-table tbody tr:nth-child(1)  { animation-delay: 0.03s; }
.token-table tbody tr:nth-child(2)  { animation-delay: 0.06s; }
.token-table tbody tr:nth-child(3)  { animation-delay: 0.09s; }
.token-table tbody tr:nth-child(4)  { animation-delay: 0.12s; }
.token-table tbody tr:nth-child(5)  { animation-delay: 0.15s; }

/* Pulse on live data update */
@keyframes dataPulse {
  0%   { opacity: 1; }
  40%  { opacity: 0.4; }
  100% { opacity: 1; }
}
.data-refresh { animation: dataPulse 1s ease; }

/* ── hidden compat elements ── */
#sub-line, #title, #desc, #chart-label, #nav, .params { display: none !important; }
#treasury-flow { display: none !important; }
</style>
</head>
<body>

<div class="app-shell">

<!-- ════════════════════════════════════════════
     LEFT SIDEBAR — brand + token list (always visible)
     ════════════════════════════════════════════ -->
<div class="app-left" id="app-left">

  <!-- Brand -->
  <a href="index.html" class="app-brand">
    <div class="app-brand-mark">N</div>
    <div class="app-brand-text">NAV<span>gator</span></div>
  </a>

  <!-- Token list (populated by JS on token pages, hidden on landing) -->
  <div class="app-token-list" id="app-token-list">
    <div id="tlp-topbar-slot">
      <div class="tp-topbar">
        <div class="tp-topbar-label">
          <span>Tokens</span>
          <span class="tp-section-count" id="tp-count">—</span>
        </div>
        <div class="tp-search-wrap">
          <span class="tp-search-icon">⌕</span>
          <input type="text" class="tp-search" id="tlp-search" placeholder="Filter…" autocomplete="off">
        </div>
      </div>
    </div>
    <div class="tp-scroll" id="tp-scroll">
      <div id="tlp-wl-section" class="tp-wl-section" style="display:none">
        <div class="tp-section-label">★ Watchlist</div>
        <div id="tlp-wl-list"></div>
      </div>
      <div class="tp-section-label">All Tokens</div>
      <div id="tlp-all-list"></div>
    </div>
    <div class="tp-footer">
      <a href="index.html">← All Markets</a>
    </div>
  </div>

</div><!-- /app-left -->

<!-- ════════════════════════════════════════════
     RIGHT — slim topbar + scrollable content
     ════════════════════════════════════════════ -->
<div class="app-right">

<div class="app-content" id="app-content">

<!-- ══ TOPNAV — inside scroll on token pages, sticky on landing ══ -->
<div class="topnav" id="global-nav">
  <a href="index.html" class="nav-brand" id="nav-brand">
    <div class="nav-brand-mark">N</div>
    <div class="nav-brand-text">NAV<span>gator</span></div>
  </a>
  <div class="nav-center">
    <a href="index.html" class="nav-link" id="nav-markets-btn">Home</a>
    <a href="index.html?compare" class="nav-link" id="nav-compare-btn">Compare</a>
  </div>
  <div class="nav-right">
    <a href="submit.html" class="nav-btn-outline">+ Submit Token</a>
    <a href="#" class="nav-btn-solid">Sign In</a>
  </div>
</div><!-- /topnav -->

<!-- ══ LANDING ══ -->
<div class="landing" id="landing-view">
  <div class="hero-strip">
    <div class="hero-title-block">
      <div class="hero-title">Ownership Token Analytics</div>
      <div class="hero-sub">Real-time NAV, treasury, and price tracking for MetaDAO ownership tokens</div>
    </div>
    <div class="hero-stats">
      <div class="hs-item">
        <div class="hs-label">Total Treasury</div>
        <div class="hs-val" id="landing-nav-total">—</div>
      </div>
      <div class="hs-item">
        <div class="hs-label">Total MCap</div>
        <div class="hs-val" id="landing-mcap-total">—</div>
      </div>
      <div class="hs-item">
        <div class="hs-label">Tokens Tracked</div>
        <div class="hs-val" id="landing-count">—</div>
      </div>
    </div>
  </div>

  <div class="filter-bar">
    <div class="filter-tabs">
      <button class="ftab active" onclick="setFilter('all',this)">All</button>
      <button class="ftab" id="nav-watchlist-tab" onclick="setFilterWatchlist(this)">★ Watchlist</button>
    </div>
    <div class="filter-right">
      <input type="text" class="filter-search" id="table-search" placeholder="Search tokens…" autocomplete="off">
    </div>
  </div>

  <div class="token-table-wrap">
    <table class="token-table" id="token-table">
      <thead>
        <tr>
          <th class="no-sort" style="cursor:default;width:36px"></th>
          <th class="no-sort" style="cursor:default;width:32px">#</th>
          <th style="text-align:left">Name</th>
          <th>Price <span style="font-size:7px;color:var(--dim);font-weight:400">7D %</span></th>
          <th>NAV / Token</th>
          <th>P/NAV</th>
          <th>Treasury</th>
          <th>MCap</th>
          <th class="no-sort" style="cursor:default">Launchpad</th>
          <th style="text-align:center">Trend 7D</th>
        </tr>
      </thead>
      <tbody id="token-tbody"></tbody>
    </table>
  </div>

  <div class="footer">
    NAVgator · Treasury analytics for ownership tokens ·
    <a href="https://metadao.fi" target="_blank">MetaDAO</a> ·
    <a href="submit.html">Submit a Token</a> ·
    Data via NAVgator API + Solana RPC · Not financial advice
  </div>
</div>

<!-- ══ COMPARE ══ -->
<div class="compare" id="compare-view">
  <div class="compare-wrap">
    <div class="compare-header">
      <a href="index.html" class="compare-back">←</a>
      <h2 class="compare-title">Compare Tokens</h2>
    </div>
    <div class="compare-selectors">
      <select id="compare-a" class="compare-select"><option value="">Select token</option></select>
      <div class="compare-swap" onclick="swapCompare()">⇄</div>
      <select id="compare-b" class="compare-select"><option value="">Select token</option></select>
    </div>
    <div class="compare-quick" id="compare-quick"></div>
    <div class="compare-body" id="compare-body">
      <div class="compare-placeholder">Select two tokens above to compare</div>
    </div>
  </div>
</div>

<!-- ══ DASHBOARD ══ -->
<div class="dashboard" id="dashboard-view">

  <!-- Hidden compat IDs used by JS -->
  <div id="sub-line" style="display:none"></div>
  <h1 id="title" style="display:none"></h1>
  <div id="chart-label" style="display:none"></div>
  <div id="params" style="display:none"></div>
  <div id="treasury-flow" style="display:none"></div>
  <div id="nav-stats-bar" style="display:none"></div>
  <div id="metrics-panel" style="display:none">
    <div id="mp-price"></div><div id="mp-nav"></div><div id="mp-vsnav"></div>
    <div id="mp-treasury"></div><div id="mp-runway"></div><div id="mp-mcap"></div>
    <div id="mp-circ"></div><div id="mp-age"></div>
    <div id="mp-chg-1h"></div><div id="mp-chg-1d"></div><div id="mp-chg-7d"></div>
    <div id="mp-watchlist-btn"></div><div id="mp-outflow"></div><div id="mp-inflow"></div>
    <div id="dash-wl-star"></div><div id="mp-wl-label"></div>
    <div id="mp-ticker-label"></div><div id="mp-mint-copy"></div><div id="cards"></div>
    <div id="desc"></div>
  </div>

  <div class="dash-body">

    <!-- ── Main column (token panel now lives in app-left shell) ── -->
    <div class="dash-main">

      <!-- HEADER: name + price -->
      <div class="token-header">
        <div class="th-left">
          <div class="th-icon" id="token-icon"></div>
          <div>
            <div class="th-name" id="token-title-name">—</div>
            <div class="th-meta">
              <span class="th-ticker" id="token-title-ticker">—</span>
              <span class="th-dot"></span>
              <span class="th-live-pill" id="th-live-pill" style="display:none">
                <span class="th-live-dot"></span>LIVE
              </span>
            </div>
          </div>
        </div>
        <div class="th-right">
          <div class="th-price" id="price-hero-val">—</div>
          <div class="th-badges">
            <span id="price-hero-pct" style="display:none"></span>
            <span id="price-hero-change" class="th-price-change" style="display:none"></span>
          </div>
        </div>
      </div>

      <!-- SNAPSHOT BAR: 4 key numbers -->
      <div class="snap-bar" id="snap-bar">
        <div class="snap-cell">
          <div class="snap-label">NAV / Token</div>
          <div class="snap-value" id="snap-nav">—</div>
          <div class="snap-sub" id="snap-nav-sub">net asset value</div>
        </div>
        <div class="snap-cell">
          <div class="snap-label">Treasury</div>
          <div class="snap-value" id="snap-treasury">—</div>
          <div class="snap-sub">total assets</div>
        </div>
        <div class="snap-cell pnav">
          <div class="snap-label">Price / NAV</div>
          <div class="snap-value" id="snap-pnav">—</div>
          <div class="snap-sub" id="snap-pnav-sub">vs floor</div>
        </div>
        <div class="snap-cell">
          <div class="snap-label">Runway</div>
          <div class="snap-value" id="snap-runway">—</div>
          <div class="snap-sub" id="snap-runway-sub">at current burn</div>
        </div>
      </div>

      <!-- BODY: chart left, data panel right -->
      <div class="token-body">

        <!-- LEFT: chart + history + addresses + allowance -->
        <div class="token-chart-col">

          <div class="chart-section">
            <div class="chart-topbar">
              <div class="chart-label" id="chart-label-vis">Price vs NAV</div>
              <div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap">
                <div class="chart-controls" id="chart-controls">
                  <button class="cbtn" data-tf="6H">6H</button>
                  <button class="cbtn" data-tf="12H">12H</button>
                  <button class="cbtn active" data-tf="1D">1D</button>
                </div>
                <div class="chart-controls">
                  <button class="cbtn active" id="btn-lin">LINE</button>
                </div>
                <div class="chart-controls">
                  <button class="cbtn" id="btn-nav-focus" onclick="toggleNavFocus()">NAV ZOOM</button>
                </div>
              </div>
            </div>
            <div class="chart-body">
              <div id="chart-container" style="position:relative">
                <canvas id="chart-canvas"></canvas>
                <div class="chart-tooltip" id="chart-tooltip"></div>
                <div class="chart-loading" id="chart-loading">Loading chart…</div>
              </div>
            </div>
            <div class="chart-legend">
              <div class="leg-item"><div class="leg-line" style="background:#c8d8e4"></div><span id="leg-spot-label">Price</span></div>
              <div class="leg-item"><div class="leg-dash"></div><span id="leg-nav-label">NAV</span></div>
              <div class="leg-item"><div class="leg-fill" style="background:rgba(0,229,160,0.18)"></div><span>Above NAV</span></div>
              <div class="leg-item"><div class="leg-fill" style="background:rgba(240,64,96,0.18)"></div><span>Below NAV</span></div>
            </div>
          </div>

          <!-- NAV history stats (rendered by JS) -->
          <div id="nav-stats-outer"></div>

          <!-- Wallet addresses -->
          <div class="section-block" id="addr-section-block">
            <div class="sb-header">
              <span class="sb-title">Wallet Addresses</span>
              <span class="sb-sub">Verified · Solana</span>
            </div>
            <div class="addr-inner" id="addr-section"></div>
          </div>

          <!-- Allowance schedule -->
          <div class="section-block" id="allowance-section" style="display:none">
            <div class="sb-header">
              <span class="sb-title">Allowance Schedule</span>
              <span class="sb-sub" id="allowance-sub-label"></span>
            </div>
            <div class="allowance-cards" id="allowance-cards"></div>
            <div class="allowance-history" id="allowance-history"></div>
          </div>

          <div class="footer" style="padding-left:24px;text-align:left;border-top:1px solid var(--bdr);margin-top:0">
            <a href="index.html">← Markets</a> ·
            <a href="submit.html">Submit Token</a> ·
            Not financial advice
          </div>

        </div><!-- /token-chart-col -->

        <!-- RIGHT: data panel -->
        <div class="token-stats-col" id="token-stats-col">

          <!-- NAV hero -->
          <div class="dp-nav" id="nc-nav-card">
            <div class="dp-nav-eyebrow">Net Asset Value</div>
            <div class="dp-nav-val" id="nc-nav-val">—</div>
            <div class="dp-nav-sub" id="nc-nav-sub">per token</div>
            <div class="dp-nav-badge above" id="nc-vs-row" style="display:none">
              <span id="nc-vs-pct">—</span>
              <span class="dp-nav-badge-lbl" id="nc-vs-label">vs floor</span>
            </div>
          </div>

          <!-- Treasury -->
          <div class="dp-treasury" id="tc-card">
            <div class="dp-sec-label">Treasury</div>
            <div class="dp-treas-total" id="tc-total">—</div>
            <div class="dp-tbar" id="tc-bar"></div>
            <div class="dp-trows" id="tc-rows"></div>
          </div>

          <!-- Valuation -->
          <div class="dp-group">
            <div class="dp-group-label">Valuation</div>
            <div class="dp-row">
              <span class="dp-key">Spot Price</span>
              <span class="dp-val" id="sc-spot">—</span>
            </div>
            <div class="dp-row">
              <span class="dp-key">Market Cap</span>
              <span class="dp-val" id="sc-mcap">—</span>
            </div>
            <div class="dp-row">
              <span class="dp-key">Circulating</span>
              <span class="dp-val dim" id="sc-circ">—</span>
            </div>
            <div class="dp-row">
              <span class="dp-key">ICO Price</span>
              <span class="dp-val dim" id="sc-ico">—</span>
            </div>
          </div>

          <!-- Treasury Health -->
          <div class="dp-group">
            <div class="dp-group-label">Treasury Health</div>
            <div class="dp-row">
              <span class="dp-key">Monthly Burn</span>
              <span class="dp-val orange" id="sc-burn">—</span>
            </div>
            <div class="dp-row">
              <span class="dp-key">Runway</span>
              <span class="dp-val" id="sc-runway">—</span>
            </div>
            <div class="dp-row">
              <span class="dp-key">Age post-TGE</span>
              <span class="dp-val dim" id="sc-age">—</span>
            </div>
          </div>

          <!-- Performance -->
          <div class="dp-group">
            <div class="dp-group-label">Performance</div>
            <div class="dp-row">
              <span class="dp-key">24H</span>
              <span class="dp-val dim" id="sc-chg-1d">—</span>
            </div>
            <div class="dp-row">
              <span class="dp-key">7D</span>
              <span class="dp-val dim" id="sc-chg-7d">—</span>
            </div>
            <div class="dp-row">
              <span class="dp-key">30D</span>
              <span class="dp-val dim" id="sc-chg-30d">—</span>
            </div>
            <div class="dp-row">
              <span class="dp-key">Since ICO</span>
              <span class="dp-val dim" id="sc-chg-ico">—</span>
            </div>
          </div>

        </div><!-- /token-stats-col -->
      </div><!-- /token-body -->

    </div><!-- /dash-main -->
  </div><!-- /dash-body -->
</div><!-- /dashboard-view -->

<!-- hidden compat: old left panel stub -->
<div id="lp-token-list" style="display:none"></div>
<div id="lp-search" style="display:none"></div>

</div><!-- /app-content -->
</div><!-- /app-right -->
</div><!-- /app-shell -->

<script>
// ═══════════════════════════════════════════════════════════════════════
// VIEW ROUTING
// ═══════════════════════════════════════════════════════════════════════
const _params = new URLSearchParams(window.location.search);
const _hasToken = _params.has('token');
const _isCompare = _params.has('compare');

if (_isCompare) {
  document.getElementById('compare-view').classList.add('active');
  document.title = 'NAVgator · Compare';
  var cmpBtn = document.getElementById('nav-compare-btn');
  if (cmpBtn) cmpBtn.classList.add('nav-active');
} else if (_hasToken) {
  document.getElementById('dashboard-view').classList.add('active');
  document.title = 'NAVgator · Dashboard';
  // Show the sidebar only on token pages
  var appLeft = document.getElementById('app-left');
  if (appLeft) appLeft.classList.add('token-mode');
  document.body.classList.add('is-token');
} else {
  document.getElementById('landing-view').classList.add('active');
  document.title = 'NAVgator — Treasury Analytics for Ownership Tokens';
  var mktsBtn = document.getElementById('nav-markets-btn');
  if (mktsBtn) mktsBtn.classList.add('nav-active');
}

// ═══════════════════════════════════════════════════════════════════════
// TOKEN CONFIGS
// ═══════════════════════════════════════════════════════════════════════
const TOKENS = {
  solo: { live: true,
    name: 'Solomon', ticker: 'SOLO', pair: 'SOLO/USDC',
    color: '#00e5a0', logo: 'logos/solo.jpg',
    mint: 'SoLo9oxzLDpcq1dpqAgMwgce5WqkRDtNXK7EPnbmeta',
    gtPool: 'o5rJFXSKTsuws58rBMNPG8jdKdnY4Z7ouU29dyohE4g',
    icoPrice: 0.80, monthlyAllowance: 100000,
    launchDate: '2025-11-18',
    launchpad: 'MetaDAO',
    spot: 0, treasuryUSDC: 0, supply: 0,
  },
  umbra: { live: true,
    name: 'Umbra', ticker: 'UMBRA', pair: 'UMBRA/USDC',
    color: '#00c2ff', logo: 'logos/umbra.jpg',
    mint: 'PRVT6TB7uss3FrUd2D9xs2zqDBsa3GbMJMwCQsgmeta',
    gtPool: '7dVri3qjYD3uobSZL3Zth8vSCgU6r6R2nvFsh7uVfDte',
    icoPrice: 0.30, monthlyAllowance: 100000,
    launchDate: '2025-10-10',
    launchpad: 'MetaDAO',
    spot: 0, treasuryUSDC: 0, supply: 0,
  },
  avici: { live: true,
    name: 'Avici', ticker: 'AVICI', pair: 'AVICI/USDC',
    color: '#ff6b9d', logo: 'logos/avici.jpg',
    mint: 'BANKJmvhT8tiJRsBSS1n2HryMBPvT5Ze4HU95DUAmeta',
    gtPool: '5gB4NPgFB3MHFHSeKN4sbaY6t9MB8ikCe9HyiKYid4Td',
    icoPrice: 0.35, monthlyAllowance: 100000,
    launchDate: '2025-10-18',
    launchpad: 'MetaDAO',
    spot: 0, treasuryUSDC: 0, supply: 0,
  },
  omfg: { live: true,
    name: 'Omnipair', ticker: 'OMFG', pair: 'OMFG/USDC',
    color: '#ff8855', logo: 'logos/omfg.png',
    mint: 'omfgRBnxHsNJh6YeGbGAmWenNkenzsXyBXm3WDhmeta',
    gtPool: 'BiNnErm2VDkbKGiABj9ZRUjybz879NhH2heeWE7m5M6d',
    icoPrice: 0.05, monthlyAllowance: 50000,
    launchDate: '2025-07-28',
    launchpad: 'MetaDAO',
    spot: 0, treasuryUSDC: 0, supply: 0,
  },
  loyal: { live: true,
    name: 'Loyal', ticker: 'LOYAL', pair: 'LOYAL/USDC',
    color: '#e63333', logo: 'logos/loyal.jpg',
    mint: 'LYLikzBQtpa9ZgVrJsqYGQpR3cC1WMJrBHaXGrQmeta',
    gtPool: 'GxpJkPEsPmuRCCTNnfZaDKg4X3gf4ZPgmqgFqtibaPtK',
    icoPrice: 0.25, monthlyAllowance: 60000,
    launchDate: '2025-10-22',
    launchpad: 'MetaDAO',
    spot: 0, treasuryUSDC: 0, supply: 0,
  },
};

// ═══════════════════════════════════════════════════════════════════════
// COMPARE PAGE
// ═══════════════════════════════════════════════════════════════════════
if (_isCompare) {
  var cmpAPI = 'https://navgator-api.vercel.app';
  var cmpFmt$ = function(n) { return n >= 1 ? '$' + n.toFixed(2) : n >= 0.01 ? '$' + n.toFixed(4) : '$' + n.toFixed(6); };
  var cmpFmtM = function(n) { return n >= 1e6 ? '$' + (n / 1e6).toFixed(2) + 'M' : n >= 1e3 ? '$' + (n / 1e3).toFixed(0) + 'K' : '$' + n.toFixed(0); };
  var cmpPct = function(n) { return (n >= 0 ? '+' : '') + n.toFixed(2) + '%'; };
  var cmpColor = function(n) { return n >= 0 ? 'var(--green)' : 'var(--red)'; };

  var selA = document.getElementById('compare-a');
  var selB = document.getElementById('compare-b');
  Object.entries(TOKENS).forEach(function(e) {
    if (!e[1].live) return;
    selA.innerHTML += '<option value="' + e[0] + '">' + e[1].ticker + ' — ' + e[1].name + '</option>';
    selB.innerHTML += '<option value="' + e[0] + '">' + e[1].ticker + ' — ' + e[1].name + '</option>';
  });

  var pairs = [['solo','umbra'], ['solo','avici'], ['avici','omfg'], ['umbra','omfg']];
  var quickEl = document.getElementById('compare-quick');
  quickEl.innerHTML = '<span style="font-size:11px;color:var(--dim)">Quick:</span>' + pairs.map(function(p) {
    return '<button class="compare-quick-btn" onclick="setCompare(\'' + p[0] + '\',\'' + p[1] + '\')">' + TOKENS[p[0]].ticker + ' / ' + TOKENS[p[1]].ticker + '</button>';
  }).join('');

  window.setCompare = function(a, b) { selA.value = a; selB.value = b; runCompare(); };
  window.swapCompare = function() { var tmp = selA.value; selA.value = selB.value; selB.value = tmp; if (selA.value && selB.value) runCompare(); };
  selA.addEventListener('change', function() { if (selA.value && selB.value) runCompare(); });
  selB.addEventListener('change', function() { if (selA.value && selB.value) runCompare(); });

  async function runCompare() {
    var kA = selA.value, kB = selB.value;
    if (!kA || !kB || kA === kB) return;
    var body = document.getElementById('compare-body');
    body.innerHTML = '<div class="compare-placeholder">Loading…</div>';
    try {
      var [resA, resB, sparkRes] = await Promise.all([
        fetch(cmpAPI + '/api/current?token=' + kA).then(function(r) { return r.json(); }),
        fetch(cmpAPI + '/api/current?token=' + kB).then(function(r) { return r.json(); }),
        fetch(cmpAPI + '/api/sparklines').then(function(r) { return r.json(); })
      ]);
      var tA = TOKENS[kA], tB = TOKENS[kB];
      var navA = resA.nav || 0, navB = resB.nav || 0;
      var spotA = resA.spot || 0, spotB = resB.spot || 0;
      var treasA = resA.treasuryUSDC || 0, treasB = resB.treasuryUSDC || 0;
      var effA = resA.effectiveSupply || tA.supply, effB = resB.effectiveSupply || tB.supply;
      var mcapA = spotA * effA, mcapB = spotB * effB;
      var discA = navA > 0 ? ((spotA - navA) / navA * 100) : 0;
      var discB = navB > 0 ? ((spotB - navB) / navB * 100) : 0;
      var burnA = resA.monthlyAllowance || tA.monthlyAllowance || 0;
      var burnB = resB.monthlyAllowance || tB.monthlyAllowance || 0;
      var runA = burnA > 0 ? Math.floor(treasA / burnA) : Infinity;
      var runB = burnB > 0 ? Math.floor(treasB / burnB) : Infinity;
      var spA = sparkRes.sparklines && sparkRes.sparklines[kA];
      var spB = sparkRes.sparklines && sparkRes.sparklines[kB];
      var chg7dA = spA && spA.length >= 2 ? ((spA[spA.length-1].p - spA[0].p) / spA[0].p * 100) : 0;
      var chg7dB = spB && spB.length >= 2 ? ((spB[spB.length-1].p - spB[0].p) / spB[0].p * 100) : 0;

      var logoA = tA.logo ? '<img src="' + tA.logo + '" style="width:100%;height:100%;object-fit:cover">' : '<div style="width:32px;height:32px;background:' + tA.color + ';border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#000;font-size:13px">' + tA.ticker[0] + '</div>';
      var logoB = tB.logo ? '<img src="' + tB.logo + '" style="width:100%;height:100%;object-fit:cover">' : '<div style="width:32px;height:32px;background:' + tB.color + ';border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#000;font-size:13px">' + tB.ticker[0] + '</div>';

      function makeBar(valA, valB, colorA, colorB, labelA, labelB, note) {
        var total = valA + valB || 1;
        var pctA = (valA / total * 100).toFixed(1);
        return '<div class="compare-bar-wrap">' +
          '<div class="compare-bar"><div class="compare-bar-a" style="width:' + pctA + '%;background:' + colorA + '"></div><div class="compare-bar-b" style="flex:1;background:' + colorB + '"></div></div>' +
          '<div class="compare-bar-labels"><span style="color:' + colorA + '">' + labelA + '</span><span style="color:' + colorB + '">' + labelB + '</span></div>' +
          (note ? '<div class="compare-bar-note">' + note + '</div>' : '') + '</div>';
      }

      function makePerfRow(valA, valB, label) {
        return '<div class="compare-perf-row">' +
          '<div class="compare-perf-left" style="color:' + cmpColor(valA) + '">' + cmpPct(valA) + '</div>' +
          '<div class="compare-perf-center">' + label + '</div>' +
          '<div class="compare-perf-right" style="color:' + cmpColor(valB) + '">' + cmpPct(valB) + '</div></div>';
      }

      body.innerHTML =
        '<div class="compare-hero-row">' +
          '<div class="compare-col"><div class="cc-token"><div class="cc-icon">' + logoA + '</div><div class="cc-name">' + tA.ticker + '</div></div>' +
            '<div class="cc-stat"><div class="cc-stat-label">Spot Price</div><div class="cc-stat-val">' + cmpFmt$(spotA) + '</div></div>' +
            '<div class="cc-stat" style="margin-top:12px"><div class="cc-stat-label">NAV</div><div class="cc-stat-val">' + cmpFmt$(navA) + '</div></div>' +
            '<div class="cc-stat" style="margin-top:12px"><div class="cc-stat-label">P/NAV</div><div class="cc-stat-val" style="color:' + (discA < 0 ? 'var(--red)' : 'var(--green)') + '">' + (discA >= 0 ? '+' : '') + discA.toFixed(1) + '%</div></div>' +
          '</div>' +
          '<div class="compare-col"><div class="cc-token"><div class="cc-icon">' + logoB + '</div><div class="cc-name">' + tB.ticker + '</div></div>' +
            '<div class="cc-stat"><div class="cc-stat-label">Spot Price</div><div class="cc-stat-val">' + cmpFmt$(spotB) + '</div></div>' +
            '<div class="cc-stat" style="margin-top:12px"><div class="cc-stat-label">NAV</div><div class="cc-stat-val">' + cmpFmt$(navB) + '</div></div>' +
            '<div class="cc-stat" style="margin-top:12px"><div class="cc-stat-label">P/NAV</div><div class="cc-stat-val" style="color:' + (discB < 0 ? 'var(--red)' : 'var(--green)') + '">' + (discB >= 0 ? '+' : '') + discB.toFixed(1) + '%</div></div>' +
          '</div>' +
        '</div>' +
        '<div class="compare-card"><div class="compare-card-label">Treasury Comparison</div>' +
          makeBar(treasA, treasB, tA.color, tB.color, tA.ticker + ' ' + cmpFmtM(treasA), tB.ticker + ' ' + cmpFmtM(treasB), '') + '</div>' +
        '<div class="compare-card"><div class="compare-card-label">Market Cap</div>' +
          makeBar(mcapA, mcapB, tA.color, tB.color, tA.ticker + ' ' + cmpFmtM(mcapA), tB.ticker + ' ' + cmpFmtM(mcapB), '') + '</div>' +
        '<div class="compare-card"><div class="compare-card-label">Performance</div>' +
          makePerfRow(chg7dA, chg7dB, '7D Price Change') +
          makePerfRow(discA, discB, 'vs NAV') + '</div>';
    } catch (e) {
      document.getElementById('compare-body').innerHTML = '<div class="compare-placeholder">Failed to load data.</div>';
    }
  }
}

// ═══════════════════════════════════════════════════════════════════════
// LANDING TABLE
// ═══════════════════════════════════════════════════════════════════════
if (!_hasToken && !_isCompare) {
  var landingTokens = Object.entries(TOKENS).map(function(e) {
    var k = e[0], v = e[1];
    return { key: k, name: v.name, ticker: v.ticker, logo: v.logo, color: v.color,
      live: v.live, monthlyAllowance: v.monthlyAllowance, launchpad: v.launchpad || null,
      spot: 0, strike: 0, treasury: 0, mcap: 0, change7d: undefined, effectiveSupply: 0 };
  });

  var lfmt$ = function(n) { return n >= 1 ? '$' + n.toFixed(2) : n >= 0.01 ? '$' + n.toFixed(4) : '$' + n.toFixed(6); };
  var lfmtK = function(n) { return n >= 1e6 ? '$' + (n / 1e6).toFixed(2) + 'M' : n >= 1e3 ? '$' + (n / 1e3).toFixed(0) + 'K' : '$' + Math.round(n); };
  function iconHtml(t) {
    if (t.logo) return '<div class="tt-icon"><img src="' + t.logo + '"></div>';
    return '<div class="tt-icon" style="background:' + (t.color || '#333') + ';display:flex;align-items:center;justify-content:center;font-family:Syne,sans-serif;font-size:14px;font-weight:700;color:#000">' + t.ticker.charAt(0) + '</div>';
  }

  var currentSort = 'treasury';
  var sortDir = 'desc';
  var sortKeys = ['', '', 'name', 'price', 'nav', 'vsNav', 'treasury', 'mcap', '', 'trend'];
  var _watchlist = JSON.parse(localStorage.getItem('navgator_watchlist') || '[]');
  var _activeFilter = 'all';
  var _tableSearch = '';

  var _starFilled = '<svg viewBox="0 0 20 18" width="14" height="14" style="fill:currentColor;flex-shrink:0"><polygon points="10,1 12.6,6.4 18.6,7.2 14.3,11.4 15.3,17.3 10,14.5 4.7,17.3 5.7,11.4 1.4,7.2 7.4,6.4" stroke-linejoin="round"/></svg>';
  var _starEmpty = '<svg viewBox="0 0 20 18" width="14" height="14" style="flex-shrink:0"><polygon points="10,1 12.6,6.4 18.6,7.2 14.3,11.4 15.3,17.3 10,14.5 4.7,17.3 5.7,11.4 1.4,7.2 7.4,6.4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>';
  function starSvg(w) { return w ? _starFilled : _starEmpty; }
  function isWatched(k) { return _watchlist.indexOf(k) !== -1; }

  window.toggleWatchStar = function(el, key) {
    var idx = _watchlist.indexOf(key);
    if (idx === -1) _watchlist.push(key); else _watchlist.splice(idx, 1);
    localStorage.setItem('navgator_watchlist', JSON.stringify(_watchlist));
    var w = isWatched(key);
    el.classList.toggle('active', w);
    el.innerHTML = starSvg(w);
    if (_activeFilter === 'watchlist') renderTable();
  };

  window.setFilter = function(f, el) {
    _activeFilter = f;
    document.querySelectorAll('.ftab').forEach(function(t) { t.classList.remove('active'); });
    if (el) el.classList.add('active');
    renderTable();
    setTimeout(drawAllSparklines, 60);
  };
  window.setFilterWatchlist = function(el) {
    _activeFilter = _activeFilter === 'watchlist' ? 'all' : 'watchlist';
    document.querySelectorAll('.ftab').forEach(function(t) { t.classList.remove('active'); });
    if (_activeFilter === 'watchlist') { el.classList.add('active'); }
    else { document.querySelector('.ftab[onclick="setFilter(\'all\',this)"]').classList.add('active'); }
    renderTable();
    setTimeout(drawAllSparklines, 60);
  };

  document.getElementById('table-search').addEventListener('input', function() {
    _tableSearch = this.value.toLowerCase().trim();
    renderTable();
    setTimeout(drawAllSparklines, 60);
  });

  function renderTable() {
    var filtered = landingTokens.filter(function(t) {
      if (_activeFilter === 'watchlist' && !isWatched(t.key)) return false;
      if (_tableSearch) {
        var q = _tableSearch;
        return t.name.toLowerCase().includes(q) || t.ticker.toLowerCase().includes(q) || t.key.includes(q);
      }
      return true;
    });

    var sorted = filtered.slice().sort(function(a, b) {
      var va, vb;
      if (currentSort === 'treasury') { va = a.treasury; vb = b.treasury; }
      else if (currentSort === 'nav') { va = a.strike; vb = b.strike; }
      else if (currentSort === 'vsNav') {
        va = a.strike > 0 ? (a.spot - a.strike) / a.strike : -999;
        vb = b.strike > 0 ? (b.spot - b.strike) / b.strike : -999;
      }
      else if (currentSort === 'mcap') { va = a.mcap; vb = b.mcap; }
      else if (currentSort === 'trend' || currentSort === 'price') { va = a.change7d || 0; vb = b.change7d || 0; }
      else if (currentSort === 'name') { return sortDir === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name); }
      else { va = a.mcap; vb = b.mcap; }
      return sortDir === 'asc' ? va - vb : vb - va;
    });

    var tbody = document.getElementById('token-tbody');
    tbody.innerHTML = sorted.map(function(t, i) {
      var lpBadge = t.launchpad
        ? '<span class="lp-badge ' + t.launchpad.toLowerCase().replace(/\s+/g, '') + '">' + t.launchpad + '</span>'
        : '<span class="lp-badge unknown">—</span>';

      if (!t.live) {
        return '<tr onclick="location.href=\'index.html?token=' + t.key + '\'" style="opacity:0.35">' +
          '<td></td><td>' + (i+1) + '</td>' +
          '<td><div class="tt-name-cell">' + iconHtml(t) + '<div><div class="tt-name">' + t.name + '</div><div class="tt-ticker">' + t.ticker + '</div></div></div></td>' +
          '<td colspan="5"><span class="tt-coming">Coming Soon</span></td>' +
          '<td>' + lpBadge + '</td>' +
          '<td></td></tr>';
      }
      var discPct = t.strike > 0 ? ((t.spot - t.strike) / t.strike * 100) : 0;
      var isDisc = discPct < 0;
      var noData = t.spot === 0;
      var navBadge = noData ? '<span class="pnav-badge neutral">—</span>' :
        t.strike === 0 ? '<span class="pnav-badge neutral">—</span>' :
        isDisc ? '<span class="pnav-badge below">-' + Math.abs(discPct).toFixed(1) + '%</span>' :
        '<span class="pnav-badge above">+' + discPct.toFixed(1) + '%</span>';
      var sw = isWatched(t.key);

      return '<tr onclick="location.href=\'index.html?token=' + t.key + '\'">' +
        '<td><span class="wl-star' + (sw ? ' active' : '') + '" onclick="event.stopPropagation();toggleWatchStar(this,\'' + t.key + '\')">' + starSvg(sw) + '</span></td>' +
        '<td>' + (i+1) + '</td>' +
        '<td><div class="tt-name-cell">' + iconHtml(t) + '<div><div class="tt-name">' + t.name + '</div><div class="tt-ticker">' + t.ticker + '</div></div></div></td>' +
        '<td><div class="tt-price">' + (noData ? '—' : lfmt$(t.spot)) + (t.change7d !== undefined ? '<div class="tt-change ' + (t.change7d >= 0 ? 'up' : 'down') + '">' + (t.change7d >= 0 ? '▲' : '▼') + ' ' + Math.abs(t.change7d).toFixed(2) + '%</div>' : '') + '</div></td>' +
        '<td class="tt-nav-val">' + (noData ? '—' : (t.strike > 0 ? lfmt$(t.strike) : '—')) + '</td>' +
        '<td>' + (noData ? '<span class="pnav-badge neutral">—</span>' : navBadge) + '</td>' +
        '<td class="tt-treasury">' + (noData ? '—' : lfmtK(t.treasury)) + '</td>' +
        '<td class="tt-mcap">' + (noData ? '—' : lfmtK(t.mcap)) + '</td>' +
        '<td>' + lpBadge + '</td>' +
        '<td><div class="spark-container tt-sparkline" data-token="' + t.key + '"></div></td>' +
        '</tr>';
    }).join('');

    if (_activeFilter === 'watchlist' && filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:48px;color:var(--dim);font-size:12px;background:var(--bg2);border:1px solid var(--bdr)">No tokens in your watchlist. Click ★ to add one.</td></tr>';
    }

    // Update header counts
    var liveCount = landingTokens.filter(function(t) { return t.live; }).length;
    var countEl = document.getElementById('landing-count');
    if (countEl) countEl.textContent = liveCount;

    // Sort indicators
    document.querySelectorAll('.token-table thead th').forEach(function(th, idx) {
      th.classList.remove('sorted');
      var key = sortKeys[idx];
      var arrow = th.querySelector('.sort-arrow');
      if (arrow) arrow.remove();
      if (key === currentSort) {
        th.classList.add('sorted');
        var arr = document.createElement('span');
        arr.className = 'sort-arrow';
        arr.textContent = sortDir === 'desc' ? ' ▼' : ' ▲';
        arr.style.cssText = 'font-size:7px;opacity:0.7';
        th.appendChild(arr);
      }
    });

    if (typeof _sparkCache !== 'undefined' && Object.keys(_sparkCache).length > 0) {
      setTimeout(drawAllSparklines, 10);
    }
  }

  renderTable();

  document.querySelectorAll('.token-table thead th').forEach(function(th, idx) {
    th.addEventListener('click', function() {
      var key = sortKeys[idx];
      if (!key) return;
      if (currentSort === key) { sortDir = sortDir === 'desc' ? 'asc' : 'desc'; }
      else { currentSort = key; sortDir = 'desc'; }
      renderTable();
    });
  });

  const API_BASE = 'https://navgator-api.vercel.app';

  async function fetchLandingData() {
    try {
      var res = await fetch(API_BASE + '/api/current');
      var data = await res.json();
      if (!data.tokens) return;
      for (var i = 0; i < data.tokens.length; i++) {
        var t = data.tokens[i];
        if (t.error) continue;
        var lt = landingTokens.find(function(x) { return x.key === t.token; });
        if (!lt) continue;
        if (t.spot > 0) { lt.spot = t.spot; lt.mcap = t.spot * (t.effectiveSupply || TOKENS[t.token].supply); }
        if (t.treasuryUSDC > 0 && t.effectiveSupply > 0) { lt.treasury = t.treasuryUSDC; lt.strike = t.treasuryUSDC / t.effectiveSupply; lt.effectiveSupply = t.effectiveSupply; }
      }
      renderTable();
      // Populate left sidebar on landing page too
      populateSidebarFromLanding();
      setTimeout(function() { loadSparklines(); }, 50);
      var totalTreasury = landingTokens.filter(function(t) { return t.live; }).reduce(function(s, t) { return s + (t.treasury || 0); }, 0);
      var el = document.getElementById('landing-nav-total');
      if (el) el.textContent = totalTreasury >= 1e6 ? '$' + (totalTreasury / 1e6).toFixed(2) + 'M' : '$' + Math.round(totalTreasury).toLocaleString();
      var totalMcap = landingTokens.filter(function(t) { return t.live; }).reduce(function(s, t) { return s + (t.mcap || 0); }, 0);
      var mcapEl = document.getElementById('landing-mcap-total');
      if (mcapEl) mcapEl.textContent = totalMcap >= 1e6 ? '$' + (totalMcap / 1e6).toFixed(2) + 'M' : '$' + Math.round(totalMcap).toLocaleString();
    } catch (e) { console.warn('API fetch failed:', e.message); }
  }

  function populateSidebarFromLanding() {
    var allList = document.getElementById('tlp-all-list');
    var countEl = document.getElementById('tp-count');
    if (!allList) return;
    var liveTokens = Object.entries(TOKENS).filter(function(e) { return e[1].live; });
    if (countEl) countEl.textContent = liveTokens.length;
    var fmtP = function(n) { return n >= 1 ? '$' + n.toFixed(2) : n > 0 ? '$' + n.toFixed(4) : '—'; };
    allList.innerHTML = liveTokens.map(function(entry) {
      var key = entry[0], tok = entry[1];
      var lt = landingTokens.find(function(x) { return x.key === key; });
      var spot = (lt && lt.spot) || 0;
      var strike = (lt && lt.strike) || 0;
      var discPct = (spot > 0 && strike > 0) ? ((spot - strike) / strike * 100) : null;
      var iconH = tok.logo
        ? '<div class="tp-icon"><img src="' + tok.logo + '" alt="' + tok.ticker + '"></div>'
        : '<div class="tp-icon" style="background:' + (tok.color||'#2a343e') + ';font-size:11px;font-weight:700;color:#fff">' + tok.ticker[0] + '</div>';
      var pnavH = discPct !== null
        ? '<span class="tp-pnav ' + (discPct >= 0 ? 'above' : 'below') + '">' + (discPct >= 0 ? '+' : '') + discPct.toFixed(1) + '%</span>'
        : '<span class="tp-pnav none">—</span>';
      return '<a class="tp-item" href="index.html?token=' + key + '">' +
        iconH +
        '<div class="tp-info"><div class="tp-name">' + tok.ticker + '</div><div class="tp-fullname">' + tok.name + '</div></div>' +
        '<div class="tp-right"><span class="tp-price">' + fmtP(spot) + '</span>' + pnavH + '</div>' +
        '</a>';
    }).join('');
  }

  // Populate sidebar immediately with no-price placeholders, then update when API responds
  populateSidebarFromLanding();

  var _sparkCache = {};

  async function loadSparklines(attempt) {
    attempt = attempt || 0;
    try {
      var res = await fetch(API_BASE + '/api/sparklines');
      if (!res.ok) { if (attempt < 2) { setTimeout(function() { loadSparklines(attempt + 1); }, 2000); } return; }
      var data = await res.json();
      if (!data.sparklines) return;
      var liveTokens = landingTokens.filter(function(t) { return t.live; });
      for (var i = 0; i < liveTokens.length; i++) {
        var t = liveTokens[i];
        var items = data.sparklines[t.key];
        if (!items || items.length < 2) continue;
        var prices = items.map(function(c) { return c.p; }).filter(function(p) { return p > 0; });
        var lastNav = items[items.length - 1].n || t.strike || 0;
        if (prices.length >= 2) {
          _sparkCache[t.key] = { prices: prices, nav: lastNav };
          t.change7d = ((prices[prices.length-1] - prices[0]) / prices[0]) * 100;
          drawSVGSparkline(t.key, prices, lastNav);
        }
      }
      renderTable();
      drawAllSparklines();
    } catch (e) { if (attempt < 2) { setTimeout(function() { loadSparklines(attempt + 1); }, 2000); } }
  }

  function drawSVGSparkline(key, prices, navVal) {
    var container = document.querySelector('.spark-container[data-token="' + key + '"]');
    if (!container || prices.length < 2) return;
    var w = 180, h = 44;
    var dpr = window.devicePixelRatio || 1;
    var canvas = document.createElement('canvas');
    canvas.width = w * dpr; canvas.height = h * dpr;
    canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
    canvas.dataset.token = key;
    container.innerHTML = '';
    container.appendChild(canvas);
    var pMin = Math.min.apply(null, prices);
    var pMax = Math.max.apply(null, prices);
    if (navVal > 0) { pMin = Math.min(pMin, navVal); pMax = Math.max(pMax, navVal); }
    var range = pMax - pMin || 1;
    pMin -= range * 0.05; pMax += range * 0.05; range = pMax - pMin;
    var first = prices[0], last = prices[prices.length - 1];
    var color = last >= first ? '#00e5a0' : '#f04060';
    var changePct = Math.abs((last - first) / first * 100);
    canvas._sparkData = { prices: prices, pMin: pMin, range: range, color: color, changePct: changePct, w: w, h: h };
    drawSparkCanvas(canvas, false);
  }

  function drawSparkCanvas(canvas, hovered) {
    var d = canvas._sparkData;
    if (!d) return;
    var dpr = window.devicePixelRatio || 1;
    var ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.scale(dpr, dpr);
    var pts = d.prices.map(function(p, i) {
      var pad = 6;
      return { x: (i / (d.prices.length - 1)) * d.w, y: pad + ((d.h - pad * 2) - ((p - d.pMin) / d.range) * (d.h - pad * 2)) };
    });
    var glowBlur = hovered ? Math.min(14, 3 + d.changePct * 0.4) : Math.min(6, 1.5 + d.changePct * 0.2);
    ctx.shadowColor = d.color;
    ctx.shadowBlur = glowBlur;
    ctx.strokeStyle = d.color;
    ctx.lineWidth = hovered ? 2 : 1.5;
    ctx.lineJoin = 'round'; ctx.lineCap = 'round';
    ctx.globalAlpha = hovered ? 0.7 : 0.3;
    ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
    for (var i = 1; i < pts.length; i++) {
      var cpx = (pts[i-1].x + pts[i].x) / 2;
      ctx.bezierCurveTo(cpx, pts[i-1].y, cpx, pts[i].y, pts[i].x, pts[i].y);
    }
    ctx.stroke();
    ctx.globalAlpha = 1; ctx.shadowBlur = hovered ? 4 : 2;
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
    for (var i = 1; i < pts.length; i++) {
      var cpx = (pts[i-1].x + pts[i].x) / 2;
      ctx.bezierCurveTo(cpx, pts[i-1].y, cpx, pts[i].y, pts[i].x, pts[i].y);
    }
    ctx.stroke();
    ctx.restore();
  }

  function drawAllSparklines() {
    Object.keys(_sparkCache).forEach(function(key) {
      drawSVGSparkline(key, _sparkCache[key].prices, _sparkCache[key].nav);
    });
  }

  fetchLandingData();
}

// ═══════════════════════════════════════════════════════════════════════
// DASHBOARD LOGIC
// ═══════════════════════════════════════════════════════════════════════
if (_hasToken) {
const params2 = new URLSearchParams(window.location.search);
const tokenKey = (params2.get('token') || 'solo').toLowerCase();
const CFG = TOKENS[tokenKey] || TOKENS.solo;
const API_BASE_DASH = 'https://navgator-api.vercel.app';

// Scroll handled by app-content div — nav is now part of the fixed shell
document.body.classList.add('is-dashboard');

document.title = 'NAVgator · ' + CFG.ticker + '/USDC — Treasury Analytics';

// Title elements label
document.getElementById('chart-label-vis').textContent = CFG.ticker + ' Price vs NAV';
document.getElementById('leg-spot-label').textContent = CFG.ticker + ' Price';
document.getElementById('leg-nav-label').textContent = CFG.ticker + ' NAV';

// ── Left panel ──
async function renderTokenLeftPanel(priceMap) {
  var watchlist = JSON.parse(localStorage.getItem('navgator_watchlist') || '[]');
  var fmtP = function(n) { return n >= 1 ? '$' + n.toFixed(2) : n > 0 ? '$' + n.toFixed(4) : '—'; };

  function makeItem(key, tok, entry) {
    var isActive = key === tokenKey;
    var spot = (entry && entry.spot) || 0;
    var strike = (entry && entry.strike) || 0;
    var discPct = (spot > 0 && strike > 0) ? ((spot - strike) / strike * 100) : null;

    var iconH = tok.logo
      ? '<div class="tp-icon"><img src="' + tok.logo + '" alt="' + tok.ticker + '"></div>'
      : '<div class="tp-icon" style="background:' + (tok.color||'#2a343e') + ';font-size:11px;font-weight:700;color:#fff">' + tok.ticker[0] + '</div>';

    var pnavH = '';
    if (discPct !== null) {
      var cls = discPct >= 0 ? 'above' : 'below';
      var sign = discPct >= 0 ? '+' : '';
      pnavH = '<span class="tp-pnav ' + cls + '">' + sign + discPct.toFixed(1) + '%</span>';
    } else {
      pnavH = '<span class="tp-pnav none">—</span>';
    }

    return '<a class="tp-item' + (isActive ? ' active' : '') + '" href="index.html?token=' + key + '">' +
      iconH +
      '<div class="tp-info">' +
        '<div class="tp-name">' + tok.ticker + '</div>' +
        '<div class="tp-fullname">' + tok.name + '</div>' +
      '</div>' +
      '<div class="tp-right">' +
        '<span class="tp-price">' + fmtP(spot) + '</span>' +
        pnavH +
      '</div>' +
    '</a>';
  }

  var liveTokens = Object.entries(TOKENS).filter(function(e) { return e[1].live; });

  // Update count badge
  var countEl = document.getElementById('tp-count');
  if (countEl) countEl.textContent = liveTokens.length;

  // Watchlist section
  var wlSection = document.getElementById('tlp-wl-section');
  var wlList    = document.getElementById('tlp-wl-list');
  var wlItems   = liveTokens.filter(function(e) { return watchlist.indexOf(e[0]) !== -1; });
  if (wlSection && wlList) {
    if (wlItems.length > 0) {
      wlSection.style.display = '';
      wlList.innerHTML = wlItems.map(function(e) { return makeItem(e[0], e[1], priceMap[e[0]]); }).join('');
    } else {
      wlSection.style.display = 'none';
      wlList.innerHTML = '';
    }
  }

  // All tokens list
  var allList = document.getElementById('tlp-all-list');
  if (allList) {
    allList.innerHTML = liveTokens.map(function(e) { return makeItem(e[0], e[1], priceMap[e[0]]); }).join('');
  }

  // Scroll active item into view
  setTimeout(function() {
    var active = document.querySelector('.tp-item.active');
    if (active) active.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  }, 50);
}

async function renderLeftPanel() {
  var priceMap = {};
  try {
    var res = await fetch(API_BASE_DASH + '/api/current');
    var json = await res.json();
    if (json.tokens) json.tokens.forEach(function(t) { priceMap[t.token] = t; });
  } catch(e) {}
  renderTokenLeftPanel(priceMap);
}
renderLeftPanel();

var tlpSearch = document.getElementById('tlp-search');
if (tlpSearch) {
  tlpSearch.addEventListener('input', function() {
    var q = this.value.toLowerCase().trim();
    ['tlp-all-list', 'tlp-wl-list'].forEach(function(id) {
      var list = document.getElementById(id);
      if (!list) return;
      list.querySelectorAll('.tp-item').forEach(function(item) {
        var nameEl = item.querySelector('.tp-name');
        var fullEl = item.querySelector('.tp-fullname');
        var ticker = nameEl ? nameEl.textContent.toLowerCase() : '';
        var fullname = fullEl ? fullEl.textContent.toLowerCase() : '';
        item.style.display = (!q || ticker.includes(q) || fullname.includes(q)) ? '' : 'none';
      });
    });
  });
}

// ── Formatting ──
const pDec = function(v) { return v >= 1 ? 2 : v >= 0.01 ? 4 : 6; };
const fmt$ = function(n, d) { return '$' + n.toFixed(d !== undefined ? d : pDec(n)); };
const fmtM = function(n) { return n >= 1e6 ? '$' + (n/1e6).toFixed(1) + 'M' : n >= 1e3 ? '$' + (n/1e3).toFixed(0) + 'K' : fmt$(n,2); };
const fmtBurn = function(n) { return n >= 1e6 ? '$' + (n/1e6).toFixed(1) + 'M' : n >= 1e3 ? '$' + (n/1e3).toFixed(0) + 'K' : '$' + n; };

// ── Fetchers ──
var _allCandles = {};
var _navPerToken = 0;
var _chartTF = '1D';
var _navFocus = false;

async function fetchCandlesForTF(tf) {
  if (_allCandles[tf] && _allCandles[tf].length > 0) return _allCandles[tf];
  if (!CFG.mint) return [];
  try {
    var now = new Date();
    var sixMonthsAgo = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);
    var url = API_BASE_DASH + '/api/ohlcv?token=' + tokenKey + '&tf=' + tf + '&time_from=' + Math.floor(sixMonthsAgo.getTime() / 1000) + '&time_to=' + Math.floor(now.getTime() / 1000);
    var resp = await fetch(url);
    var json = await resp.json();
    if (!json.data || !json.data.items) return [];
    var candles = json.data.items.map(function(c) {
      return { date: new Date(c.unixTime * 1000), time: c.unixTime, open: c.o, high: c.h, low: c.l, close: c.c, price: c.c };
    });
    if (candles.length > 0) _allCandles[tf] = candles;
    return candles;
  } catch(e) { return []; }
}

async function fetchOHLCV() {
  var candles = await fetchCandlesForTF('1D');
  return candles.length > 0 ? candles : null;
}

async function fetchFromAPI() {
  try {
    var res = await fetch(API_BASE_DASH + '/api/current?token=' + tokenKey);
    var data = await res.json();
    if (data.error) return false;
    if (data.spot > 0) CFG.spot = data.spot;
    if (data.treasuryUSDC > 0) CFG.treasuryUSDC = data.treasuryUSDC;
    if (data.effectiveSupply > 0) CFG.effectiveSupply = data.effectiveSupply;
    if (data.onChainSupply > 0) CFG.onChainSupply = data.onChainSupply;
    if (data.lockedTokens > 0) CFG.lockTokenBalance = data.lockedTokens;
    if (data.ammTokens > 0) CFG.ammTokens = data.ammTokens;
    if (data.daoTokens > 0) CFG.daoTokenBalance = data.daoTokens;
    if (data.buybackTokens > 0) CFG.buybackTokenBalance = data.buybackTokens;
    if (data.futAmmTokens >= 0) CFG.futAmmTokens = data.futAmmTokens;
    if (data.metAmmTokens >= 0) CFG.metAmmTokens = data.metAmmTokens;
    if (data.meteoraPoolUSDC >= 0) CFG.metAmmUSDC = data.meteoraPoolUSDC;
    if (data.futAmmUSDC >= 0) CFG.futAmmUSDC = data.futAmmUSDC;
    if (data.daoUSDC >= 0) CFG.daoUSDC = data.daoUSDC;
    if (data.nav > 0) CFG.nav = data.nav;
    if (data.monthlyAllowance > 0) CFG.monthlyAllowance = data.monthlyAllowance;
    return true;
  } catch(e) { return false; }
}

// ── Chart ──
var _chart = {
  canvas: null, ctx: null, tooltip: null,
  priceData: [], navData: [],
  viewStart: 0, viewEnd: 1,
  isDragging: false, dragStartX: 0, dragStartView: 0,
  isYDragging: false, yDragStartY: 0, yDragStartZoom: 1, yDragStartOffset: 0,
  isXDragging: false, xDragStartX: 0, xDragStartViewStart: 0, xDragStartViewEnd: 0,
  yZoom: 1, yOffset: 0,
  width: 0, height: 440,
  padding: { top: 20, right: 72, bottom: 48, left: 24 },
};

function buildChart(candles, navPerToken) {
  var container = document.getElementById('chart-container');
  var canvas = document.getElementById('chart-canvas');
  var tooltip = document.getElementById('chart-tooltip');
  if (!canvas || !container) return;

  var dpr = window.devicePixelRatio || 1;
  var w = container.clientWidth || 800;
  var h = _chart.height;

  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  _chart.canvas = canvas; _chart.ctx = canvas.getContext('2d');
  _chart.ctx.scale(dpr, dpr);
  _chart.tooltip = tooltip; _chart.width = w;

  var priceData = [];
  if (candles && candles.length > 0) {
    priceData = candles.map(function(c) { return { time: c.time || Math.floor(c.date.getTime() / 1000), value: c.close || c.price }; });
  }
  if (CFG.icoPrice > 0 && priceData.length > 0) {
    priceData.unshift({ time: priceData[0].time - 86400, value: CFG.icoPrice });
  }
  if (priceData.length === 0 && CFG.spot > 0 && CFG.icoPrice > 0) {
    var nowTs = Math.floor(Date.now() / 1000);
    priceData.push({ time: nowTs - 86400 * 90, value: CFG.icoPrice });
    priceData.push({ time: nowTs, value: CFG.spot });
  }
  _chart.priceData = priceData;
  if (CFG.spot > 0 && priceData.length > 0) {
    var nowTs2 = Math.floor(Date.now() / 1000);
    var lastC = priceData[priceData.length - 1];
    if (nowTs2 > lastC.time) priceData.push({ time: nowTs2, value: CFG.spot });
  }
  _chart.currentNav = navPerToken;
  _chart.viewStart = 0; _chart.viewEnd = 1;
  attachChartEvents(container);
  drawChart();
}

function drawChart() {
  var ctx = _chart.ctx;
  if (!ctx) return;
  var w = _chart.width, h = _chart.height;
  var pad = _chart.padding;

  ctx.clearRect(0, 0, w, h);

  var priceData = _chart.priceData;
  if (!priceData || priceData.length < 2) { return; }

  var times = priceData.map(function(d) { return d.time; });
  var tFull = { min: Math.min.apply(null, times), max: Math.max.apply(null, times) };
  var tRange = tFull.max - tFull.min || 1;
  var tMin = tFull.min + _chart.viewStart * tRange;
  var tMax = tFull.min + _chart.viewEnd * tRange;

  var visData = priceData.filter(function(d) { return d.time >= tMin && d.time <= tMax; });
  if (visData.length < 1) return;

  var vals = visData.map(function(d) { return d.value; });
  var currentNav = _chart.currentNav || 0;
  if (currentNav > 0) vals.push(currentNav);

  var vMin = Math.min.apply(null, vals);
  var vMax = Math.max.apply(null, vals);
  var vRange = vMax - vMin || 1;

  var plotW = w - pad.left - pad.right;
  var plotH = h - pad.top - pad.bottom;

  if (_navFocus && currentNav > 0) {
    var spread = Math.max(vRange * 0.1, currentNav * 0.1);
    vMin = currentNav - spread;
    vMax = currentNav + spread;
    vRange = vMax - vMin;
  } else {
    var padding2 = vRange * 0.06 / _chart.yZoom;
    var centeredMin = vMin - padding2;
    var centeredMax = vMax + padding2;
    var centeredRange = centeredMax - centeredMin;
    var center = (centeredMax + centeredMin) / 2 + _chart.yOffset;
    vMin = center - centeredRange / 2 / _chart.yZoom;
    vMax = center + centeredRange / 2 / _chart.yZoom;
    vRange = vMax - vMin;
  }

  var tx = function(t) { return pad.left + ((t - tMin) / (tMax - tMin)) * plotW; };
  var ty = function(v) { return pad.top + (1 - (v - vMin) / vRange) * plotH; };

  // Grid
  var gridSteps = 8;
  for (var i = 0; i <= gridSteps; i++) {
    var gy = pad.top + (i / gridSteps) * plotH;
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(28,34,40,0.9)';
    ctx.lineWidth = 1;
    ctx.moveTo(pad.left, gy); ctx.lineTo(w - pad.right, gy);
    ctx.stroke();
    var gVal = vMax - (i / gridSteps) * vRange;
    ctx.fillStyle = '#3d4d5c';
    ctx.font = '10px "IBM Plex Mono", monospace';
    ctx.textAlign = 'left';
    ctx.fillText('$' + gVal.toFixed(gVal >= 1 ? 2 : 4), w - pad.right + 8, gy + 3.5);
  }

  // Time labels
  ctx.fillStyle = '#3d4d5c';
  ctx.font = '10px Inter, sans-serif';
  var tSteps = 6;
  for (var i = 0; i <= tSteps; i++) {
    var tVal = tMin + (i / tSteps) * (tMax - tMin);
    var date = new Date(tVal * 1000);
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var label = months[date.getUTCMonth()] + ' ' + date.getUTCDate();
    var xPos = tx(tVal);
    ctx.textAlign = i === 0 ? 'left' : i === tSteps ? 'right' : 'center';
    xPos = i === 0 ? Math.max(pad.left, xPos) : i === tSteps ? Math.min(w - pad.right, xPos) : xPos;
    ctx.fillText(label, xPos, h - 8);
  }

  function toPixels(data) {
    var pts = [], lastBefore = null, firstAfter = null;
    for (var i = 0; i < data.length; i++) {
      if (data[i].time < tMin) { lastBefore = data[i]; }
      else if (data[i].time <= tMax) { pts.push({ x: tx(data[i].time), y: ty(data[i].value), value: data[i].value, time: data[i].time }); }
      else if (!firstAfter) { firstAfter = data[i]; }
    }
    if (lastBefore) {
      var nextPt = pts.length > 0 ? pts[0] : firstAfter;
      if (nextPt) {
        var frac = (tMin - lastBefore.time) / (nextPt.time - lastBefore.time);
        var iv = lastBefore.value + frac * (nextPt.value - lastBefore.value);
        pts.unshift({ x: tx(tMin), y: ty(iv), value: iv, time: tMin });
      }
    }
    if (pts.length > 0) {
      var lpt = pts[pts.length - 1];
      if (lpt.time < tMax && firstAfter) {
        var frac2 = (tMax - lpt.time) / (firstAfter.time - lpt.time);
        var iv2 = lpt.value + frac2 * (firstAfter.value - lpt.value);
        pts.push({ x: tx(tMax), y: ty(iv2), value: iv2, time: tMax });
      }
    }
    return pts;
  }

  var pricePts = toPixels(priceData);
  var navLineY = currentNav > 0 ? ty(currentNav) : null;

  // Fills
  if (pricePts.length > 1 && navLineY !== null) {
    var allY = pricePts.map(function(p) { return p.y; });
    var minY = Math.min.apply(null, allY), maxY = Math.max.apply(null, allY);

    ctx.save();
    // Above fill
    var aboveGrad = ctx.createLinearGradient(0, minY, 0, navLineY);
    aboveGrad.addColorStop(0, 'rgba(0,229,160,0.22)');
    aboveGrad.addColorStop(1, 'rgba(0,229,160,0.02)');
    ctx.beginPath();
    for (var i = 0; i < pricePts.length; i++) {
      var cy = Math.min(pricePts[i].y, navLineY);
      if (i === 0) ctx.moveTo(pricePts[i].x, cy);
      else ctx.lineTo(pricePts[i].x, cy);
    }
    for (var i = pricePts.length - 1; i >= 0; i--) ctx.lineTo(pricePts[i].x, navLineY);
    ctx.closePath(); ctx.fillStyle = aboveGrad; ctx.fill();

    // Below fill
    var belowGrad = ctx.createLinearGradient(0, maxY, 0, navLineY);
    belowGrad.addColorStop(0, 'rgba(240,64,96,0.22)');
    belowGrad.addColorStop(1, 'rgba(240,64,96,0.02)');
    ctx.beginPath();
    for (var i = 0; i < pricePts.length; i++) {
      var cy2 = Math.max(pricePts[i].y, navLineY);
      if (i === 0) ctx.moveTo(pricePts[i].x, cy2);
      else ctx.lineTo(pricePts[i].x, cy2);
    }
    for (var i = pricePts.length - 1; i >= 0; i--) ctx.lineTo(pricePts[i].x, navLineY);
    ctx.closePath(); ctx.fillStyle = belowGrad; ctx.fill();
    ctx.restore();
  }

  // Price line
  if (pricePts.length > 1) {
    ctx.beginPath();
    ctx.strokeStyle = '#c8d8e4';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round'; ctx.lineCap = 'round';
    ctx.moveTo(pricePts[0].x, pricePts[0].y);
    for (var i = 1; i < pricePts.length; i++) ctx.lineTo(pricePts[i].x, pricePts[i].y);
    ctx.stroke();
  }

  // NAV line
  if (navLineY !== null) {
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(200,216,228,0.45)';
    ctx.lineWidth = 1; ctx.setLineDash([8, 5]); ctx.lineCap = 'butt';
    ctx.moveTo(pad.left, Math.round(navLineY) + 0.5);
    ctx.lineTo(w - pad.right, Math.round(navLineY) + 0.5);
    ctx.stroke(); ctx.setLineDash([]);

    var navText = currentNav >= 1 ? '$' + currentNav.toFixed(2) : '$' + currentNav.toFixed(4);
    ctx.font = 'bold 10px "IBM Plex Mono", monospace';
    var nbW = ctx.measureText(navText).width + 12;
    var nbX = w - pad.right + 4;
    ctx.fillStyle = 'rgba(200,216,228,0.9)';
    ctx.beginPath();
    ctx.roundRect(nbX, navLineY - 9, nbW, 18, 3);
    ctx.fill();
    ctx.fillStyle = '#080a0c'; ctx.textAlign = 'left';
    ctx.fillText(navText, nbX + 6, navLineY + 3.5);
  }

  // Price badge
  if (pricePts.length > 0) {
    var lastPt = pricePts[pricePts.length - 1];
    var lastPrice = priceData[priceData.length - 1].value;
    var priceText = lastPrice >= 1 ? '$' + lastPrice.toFixed(2) : '$' + lastPrice.toFixed(4);
    ctx.font = 'bold 10px "IBM Plex Mono", monospace';
    var bW = ctx.measureText(priceText).width + 12;
    var bX = w - pad.right + 4;
    ctx.fillStyle = 'rgba(200,216,228,0.9)';
    ctx.beginPath();
    ctx.roundRect(bX, lastPt.y - 9, bW, 18, 3);
    ctx.fill();
    ctx.fillStyle = '#080a0c'; ctx.textAlign = 'left';
    ctx.fillText(priceText, bX + 6, lastPt.y + 3.5);
  }

  _chart._pricePts = pricePts;
  _chart._navLineY = navLineY;
  _chart._tx = tx; _chart._ty = ty;
  _chart._tMin = tMin; _chart._tMax = tMax;
  _chart._vMin = vMin; _chart._vMax = vMax;
}

function attachChartEvents(container) {
  if (container._eventsAttached) return;
  container._eventsAttached = true;
  var canvas = _chart.canvas;

  canvas.addEventListener('mousemove', function(e) {
    if (_chart.isDragging || _chart.isYDragging || _chart.isXDragging) return;
    var rect = canvas.getBoundingClientRect();
    var mx = e.clientX - rect.left;
    var my = e.clientY - rect.top;
    var mxS = mx * (_chart.width / rect.width);
    var myS = my * (_chart.height / rect.height);
    var dz = 48;
    if (mxS > _chart.width - dz && myS <= _chart.height - dz) canvas.style.cursor = 'ns-resize';
    else if (myS > _chart.height - dz) canvas.style.cursor = 'ew-resize';
    else if (mxS >= _chart.padding.left && mxS <= _chart.width - dz && myS >= _chart.padding.top && myS <= _chart.height - dz) canvas.style.cursor = 'crosshair';
    else canvas.style.cursor = 'default';
    drawChart();
    drawCrosshair(mx, my);
  });

  canvas.addEventListener('mouseleave', function() {
    if (!_chart.isDragging) drawChart();
    if (_chart.tooltip) _chart.tooltip.style.display = 'none';
  });

  canvas.addEventListener('wheel', function(e) {
    e.preventDefault();
    var rect = canvas.getBoundingClientRect();
    var mx = (e.clientX - rect.left) * (_chart.width / rect.width);
    if (mx > _chart.width - 48) {
      _chart.yZoom = Math.max(0.2, Math.min(10, _chart.yZoom * (e.deltaY > 0 ? 0.97 : 1.03)));
    } else {
      var mxN = (e.clientX - rect.left) / rect.width;
      var zf = e.deltaY > 0 ? 1.03 : 0.97;
      var range = _chart.viewEnd - _chart.viewStart;
      var newRange = Math.min(1, Math.max(0.2, range * zf));
      var center = _chart.viewStart + mxN * range;
      var newStart = Math.max(0, center - mxN * newRange);
      var newEnd = newStart + newRange;
      if (newEnd > 1) { newEnd = 1; newStart = newEnd - newRange; }
      _chart.viewStart = newStart; _chart.viewEnd = newEnd;
    }
    drawChart();
  }, { passive: false });

  canvas.addEventListener('mousedown', function(e) {
    var rect = canvas.getBoundingClientRect();
    var mx = (e.clientX - rect.left) * (_chart.width / rect.width);
    var my = (e.clientY - rect.top) * (_chart.height / rect.height);
    var dz = 48;
    if (mx > _chart.width - dz && my <= _chart.height - dz) {
      _chart.isYDragging = true; _chart.yDragStartY = e.clientY; _chart.yDragStartZoom = _chart.yZoom;
      canvas.style.cursor = 'ns-resize'; if (_chart.tooltip) _chart.tooltip.style.display = 'none'; e.preventDefault(); return;
    }
    if (my > _chart.height - dz) {
      _chart.isXDragging = true; _chart.xDragStartX = e.clientX;
      _chart.xDragStartViewStart = _chart.viewStart; _chart.xDragStartViewEnd = _chart.viewEnd;
      canvas.style.cursor = 'ew-resize'; if (_chart.tooltip) _chart.tooltip.style.display = 'none'; e.preventDefault(); return;
    }
    _chart.isDragging = true;
    _chart.dragStartX = e.clientX; _chart.dragStartY = e.clientY;
    _chart.dragStartViewStart = _chart.viewStart; _chart.dragStartViewEnd = _chart.viewEnd;
    _chart.dragRange = _chart.viewEnd - _chart.viewStart;
    _chart.dragStartYOffset = _chart.yOffset;
    _chart.dragYSensitivity = (_chart._vMax - _chart._vMin) || 1;
    canvas.style.cursor = 'grabbing'; if (_chart.tooltip) _chart.tooltip.style.display = 'none'; e.preventDefault();
  });

  window.addEventListener('mousemove', function(e) {
    if (_chart.isYDragging) {
      var dy = e.clientY - _chart.yDragStartY;
      var rect = _chart.canvas.getBoundingClientRect();
      var zd = 1 + (dy / rect.height) * 2;
      _chart.yZoom = Math.max(0.1, Math.min(20, _chart.yDragStartZoom / Math.max(0.1, zd)));
      drawChart(); return;
    }
    if (_chart.isXDragging) {
      var dx = e.clientX - _chart.xDragStartX;
      var rect = _chart.canvas.getBoundingClientRect();
      var range = _chart.xDragStartViewEnd - _chart.xDragStartViewStart;
      var zf = 1 + (dx / rect.width) * 2;
      var newRange = Math.min(1, Math.max(0.05, range / Math.max(0.1, zf)));
      var newEnd = _chart.xDragStartViewEnd;
      var newStart = Math.max(0, newEnd - newRange);
      _chart.viewStart = newStart; _chart.viewEnd = newEnd;
      drawChart(); return;
    }
    if (!_chart.isDragging) return;
    var rect = _chart.canvas.getBoundingClientRect();
    var dx = e.clientX - _chart.dragStartX;
    var dy = e.clientY - _chart.dragStartY;
    var shift = -(dx / rect.width) * _chart.dragRange;
    var newStart = Math.max(0, Math.min(_chart.dragStartViewStart + shift, 1 - _chart.dragRange));
    _chart.viewStart = newStart; _chart.viewEnd = newStart + _chart.dragRange;
    var rawOff = _chart.dragStartYOffset + (dy / rect.height) * _chart.dragYSensitivity;
    var maxOff = _chart.dragYSensitivity * 0.3;
    _chart.yOffset = Math.max(-maxOff, Math.min(maxOff, rawOff));
    drawChart();
  });

  window.addEventListener('mouseup', function() {
    _chart.isDragging = _chart.isYDragging = _chart.isXDragging = false;
    if (_chart.canvas) _chart.canvas.style.cursor = 'default';
  });

  canvas.addEventListener('dblclick', function() {
    _chart.viewStart = 0; _chart.viewEnd = 1; _chart.yZoom = 1; _chart.yOffset = 0; drawChart();
  });

  if (!container._resizeObserver) {
    container._resizeObserver = new ResizeObserver(function() {
      var dpr = window.devicePixelRatio || 1;
      var w = container.clientWidth;
      var canvas = _chart.canvas;
      canvas.width = w * dpr; canvas.style.width = w + 'px';
      _chart.width = w; _chart.ctx = canvas.getContext('2d'); _chart.ctx.scale(dpr, dpr);
      drawChart();
    });
    container._resizeObserver.observe(container);
  }
}

function drawCrosshair(mx, my) {
  var ctx = _chart.ctx;
  var w = _chart.width, h = _chart.height, pad = _chart.padding;
  if (!ctx || mx < pad.left || mx > w - pad.right || my < pad.top || my > h - pad.bottom) {
    if (_chart.tooltip) _chart.tooltip.style.display = 'none';
    return;
  }
  drawChart();

  ctx.beginPath();
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1; ctx.setLineDash([3, 4]);
  ctx.moveTo(mx, pad.top); ctx.lineTo(mx, h - pad.bottom);
  ctx.moveTo(pad.left, my); ctx.lineTo(w - pad.right, my);
  ctx.stroke(); ctx.setLineDash([]);

  var plotW = w - pad.left - pad.right;
  var plotH = h - pad.top - pad.bottom;
  var cursorTime = _chart._tMin + ((mx - pad.left) / plotW) * (_chart._tMax - _chart._tMin);
  var cursorDate = new Date(cursorTime * 1000);
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var dateLabel = months[cursorDate.getUTCMonth()] + ' ' + cursorDate.getUTCDate();

  ctx.font = '10px "IBM Plex Mono", monospace';
  ctx.textAlign = 'center';
  var dm = ctx.measureText(dateLabel);
  ctx.fillStyle = 'rgba(22,27,32,0.95)';
  ctx.beginPath(); ctx.roundRect(mx - dm.width/2 - 6, h - pad.bottom - 18, dm.width + 12, 16, 3); ctx.fill();
  ctx.fillStyle = '#8ba0b2'; ctx.fillText(dateLabel, mx, h - pad.bottom - 5);

  var cursorPrice = _chart._vMax - ((my - pad.top) / plotH) * (_chart._vMax - _chart._vMin);
  var priceLabel = cursorPrice >= 1 ? '$' + cursorPrice.toFixed(2) : '$' + cursorPrice.toFixed(4);
  ctx.textAlign = 'left';
  var pm = ctx.measureText(priceLabel);
  ctx.fillStyle = 'rgba(22,27,32,0.95)';
  ctx.beginPath(); ctx.roundRect(w - pad.right + 4, my - 9, pm.width + 12, 18, 3); ctx.fill();
  ctx.fillStyle = '#8ba0b2'; ctx.fillText(priceLabel, w - pad.right + 10, my + 4);

  var pricePts = _chart._pricePts || [];
  var closest = null, closestDist = Infinity;
  for (var i = 0; i < pricePts.length; i++) {
    var d = Math.abs(pricePts[i].x - mx);
    if (d < closestDist) { closestDist = d; closest = pricePts[i]; }
  }
  if (closest && closestDist < 50) {
    ctx.beginPath();
    ctx.arc(mx, closest.y, 4, 0, Math.PI * 2);
    ctx.fillStyle = '#c8d8e4'; ctx.fill();
    if (_chart._navLineY !== null) {
      ctx.beginPath();
      ctx.arc(mx, _chart._navLineY, 4, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(200,216,228,0.5)'; ctx.fill();
    }

    // Tooltip
    var tooltip = _chart.tooltip;
    if (tooltip) {
      var discVsNav = _chart.currentNav > 0 ? ((closest.value - _chart.currentNav) / _chart.currentNav * 100) : null;
      var navStr = _chart.currentNav > 0 ? fmt$(_chart.currentNav) : '—';
      var discStr = discVsNav !== null ? ((discVsNav >= 0 ? '+' : '') + discVsNav.toFixed(1) + '%') : '—';
      tooltip.innerHTML =
        '<div class="tt-date">' + dateLabel + '</div>' +
        '<div class="tt-row"><span class="tt-key">Price</span><span class="tt-v">' + fmt$(closest.value) + '</span></div>' +
        '<div class="tt-row"><span class="tt-key">NAV</span><span class="tt-v">' + navStr + '</span></div>' +
        '<div class="tt-row"><span class="tt-key">vs NAV</span><span class="tt-v" style="color:' + (discVsNav !== null ? (discVsNav >= 0 ? 'var(--green)' : 'var(--red)') : 'var(--muted)') + '">' + discStr + '</span></div>';
      tooltip.style.display = 'block';
      var tooltipX = mx + 16;
      var tooltipY = my - 20;
      var rect = _chart.canvas.getBoundingClientRect();
      var canvasW = rect.width;
      if (tooltipX + 180 > canvasW) tooltipX = mx - 196;
      tooltip.style.left = tooltipX + 'px';
      tooltip.style.top = Math.max(0, tooltipY) + 'px';
    }
  } else {
    if (_chart.tooltip) _chart.tooltip.style.display = 'none';
  }
}

function toggleNavFocus() {
  _navFocus = !_navFocus;
  document.getElementById('btn-nav-focus').classList.toggle('active', _navFocus);
  drawChart();
}
window.toggleNavFocus = toggleNavFocus;

function initChart(rawCandles, navPerToken) {
  _allCandles['1D'] = rawCandles;
  _navPerToken = navPerToken;

  function updateMetricChanges(candles) {
    if (!candles || candles.length < 2) return;
    var lastPrice = candles[candles.length - 1].close || candles[candles.length - 1].price;
    var now = candles[candles.length - 1].time;
    function calcChange(hours) {
      var cutoff = now - hours * 3600;
      for (var i = 0; i < candles.length; i++) {
        if (candles[i].time >= cutoff) {
          var op = candles[i].open || candles[i].close;
          if (op && op > 0) return ((lastPrice - op) / op) * 100;
          break;
        }
      }
      return null;
    }
    // Write to new sidebar sc-chg-* elements
    function setSidebarChg(id, pct) {
      var el = document.getElementById(id);
      if (!el) return;
      if (pct === null) { el.textContent = '—'; el.className = 'dp-val dim'; return; }
      el.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
      el.className = 'dp-val ' + (pct >= 0 ? 'green' : 'red');
    }
    setSidebarChg('sc-chg-1d',  calcChange(24));
    setSidebarChg('sc-chg-7d',  calcChange(168));
    setSidebarChg('sc-chg-30d', calcChange(720));

    // price-hero-pct (timeframe badge)
    var tfHours = { '6H': 6, '12H': 12, '1D': 24 }[_chartTF] || 24;
    var cutoff2 = now - tfHours * 3600;
    var first = candles[0];
    for (var i = 0; i < candles.length; i++) {
      if (candles[i].time >= cutoff2) { first = candles[i]; break; }
    }
    var openPrice = first.open || first.close;
    var pctEl = document.getElementById('price-hero-pct');
    if (pctEl && openPrice && openPrice > 0) {
      var pct = ((lastPrice - openPrice) / openPrice) * 100;
      pctEl.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
      pctEl.style.background = pct >= 0 ? 'rgba(0,229,160,0.1)' : 'rgba(240,64,96,0.1)';
      pctEl.style.color = pct >= 0 ? 'var(--green)' : 'var(--red)';
      pctEl.style.border = pct >= 0 ? '1px solid rgba(0,229,160,0.15)' : '1px solid rgba(240,64,96,0.15)';
      pctEl.style.borderRadius = '5px';
      pctEl.style.padding = '3px 9px';
      pctEl.style.fontSize = '11px';
      pctEl.style.display = 'inline';
    }
  }

  buildChart(rawCandles, navPerToken);
  updateMetricChanges(rawCandles);

  var controls = document.getElementById('chart-controls');
  if (controls) {
    controls.addEventListener('click', async function(e) {
      var btn = e.target.closest('.cbtn');
      if (!btn || !btn.dataset.tf) return;
      if (btn.dataset.tf === _chartTF) return;
      controls.querySelectorAll('[data-tf]').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      _chartTF = btn.dataset.tf;
      _chart.viewStart = 0; _chart.viewEnd = 1; _chart.yZoom = 1; _chart.yOffset = 0;
      var candles = await fetchCandlesForTF(_chartTF);
      if (candles.length === 0) candles = rawCandles;
      buildChart(candles, _navPerToken);
      updateMetricChanges(candles);
      renderNAVStats(candles, _navPerToken);
    });
  }
}

// ── Render UI ──
function renderUI(isLive) {
  var supplyForNAV = CFG.effectiveSupply || CFG.supply || 1;
  var strike = supplyForNAV > 1 ? CFG.treasuryUSDC / supplyForNAV : 0;
  var itm = CFG.spot < strike;
  var burn = CFG.monthlyAllowance || 0;
  var monthsLeft = burn > 0 ? Math.floor(CFG.treasuryUSDC / burn) : '∞';
  var discPct = strike > 0 ? ((CFG.spot - strike) / strike * 100) : 0;
  var isDiscount = discPct < 0;
  var circulatingSupply = (CFG.onChainSupply || supplyForNAV) - (CFG.lockTokenBalance || 0);
  if (circulatingSupply <= 0) circulatingSupply = supplyForNAV;

  // Token icon + name
  var iconEl = document.getElementById('token-icon');
  if (iconEl) {
    if (CFG.logo) iconEl.innerHTML = '<img src="' + CFG.logo + '" alt="' + CFG.ticker + '" style="width:100%;height:100%;object-fit:cover;display:block">';
    else iconEl.innerHTML = '<div style="width:100%;height:100%;background:' + (CFG.color||'#333') + ';border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:Syne,sans-serif;font-size:18px;font-weight:700;color:#fff">' + CFG.ticker.charAt(0) + '</div>';
  }
  document.getElementById('token-title-name').textContent = CFG.name;
  document.getElementById('token-title-ticker').textContent = CFG.ticker;

  // Live pill
  if (isLive) {
    var livePill = document.getElementById('th-live-pill');
    if (livePill) livePill.style.display = 'flex';
  }

  // Price hero
  document.getElementById('price-hero-val').textContent = fmt$(CFG.spot);
  var phc = document.getElementById('price-hero-change');
  if (phc) {
    phc.textContent = (isDiscount ? '' : '+') + discPct.toFixed(2) + '% vs NAV';
    phc.className = 'th-price-change ' + (isDiscount ? 'down' : 'up');
    phc.style.display = 'inline-block';
  }

  // Hidden compat IDs
  document.getElementById('sub-line').innerHTML = CFG.pair + ' · ' + (isLive ? 'LIVE' : 'SNAPSHOT');
  document.getElementById('title').textContent = CFG.ticker;
  document.getElementById('chart-label').textContent = CFG.ticker + ' Price vs NAV';
  document.getElementById('leg-spot-label').textContent = CFG.ticker + ' Price';
  document.getElementById('leg-nav-label').textContent = CFG.ticker + ' NAV';
  document.getElementById('chart-label-vis').textContent = CFG.ticker + ' · Price vs NAV';

  // ── NAV card ──
  var ncNav = document.getElementById('nc-nav-val');
  if (ncNav) ncNav.textContent = fmt$(strike);
  var ncSub = document.getElementById('nc-nav-sub');
  if (ncSub) ncSub.textContent = fmtM(CFG.treasuryUSDC) + ' ÷ ' + (circulatingSupply / 1e6).toFixed(2) + 'M tokens';
  var ncVsRow = document.getElementById('nc-vs-row');
  var ncVsPct  = document.getElementById('nc-vs-pct');
  var ncVsLbl  = document.getElementById('nc-vs-label');
  if (ncVsRow && ncVsPct && strike > 0) {
    ncVsRow.style.display = 'flex';
    ncVsRow.className = 'dp-nav-badge ' + (isDiscount ? 'below' : 'above');
    ncVsPct.textContent = (isDiscount ? '' : '+') + discPct.toFixed(2) + '%';
    ncVsLbl.textContent = isDiscount ? 'below floor' : 'above floor';
  }

  // ── Treasury card ──
  var totalTreasury = CFG.treasuryUSDC || 0;
  var daoUSDC = CFG.daoUSDC || 0;
  var futUSDC = CFG.futAmmUSDC || 0;
  var metUSDC = CFG.metAmmUSDC || 0;
  var safe = totalTreasury || 1;

  var tcTotal = document.getElementById('tc-total');
  if (tcTotal) tcTotal.textContent = fmtM(totalTreasury);

  var tcBar = document.getElementById('tc-bar');
  if (tcBar) {
    var segs = [
      { pct: (daoUSDC / safe * 100), color: 'var(--green)' },
      { pct: (futUSDC / safe * 100), color: '#4d8fff' },
      { pct: (metUSDC / safe * 100), color: '#a48ffc' },
    ].filter(function(s) { return s.pct > 0; });
    tcBar.innerHTML = segs.map(function(s) {
      return '<div class="dp-tbar-seg" style="width:' + s.pct.toFixed(1) + '%;background:' + s.color + '"></div>';
    }).join('');
  }

  var tcRows = document.getElementById('tc-rows');
  if (tcRows) {
    var sources = [
      { label: 'DAO Treasury',  val: daoUSDC, color: 'var(--green)' },
      { label: 'Futarchy AMM',  val: futUSDC, color: '#4d8fff' },
      { label: 'Meteora AMM',   val: metUSDC, color: '#a48ffc' },
    ].filter(function(r) { return r.val > 0; });
    tcRows.innerHTML = sources.map(function(r) {
      return '<div class="dp-trow"><span class="dp-trow-left"><span class="dp-tdot" style="background:' + r.color + '"></span>' + r.label + '</span><span class="dp-trow-right">' + fmtM(r.val) + '</span></div>';
    }).join('');
  }

  // ── Valuation stats ──
  var set = function(id, text, cls) {
    var el = document.getElementById(id);
    if (!el) return;
    el.textContent = text;
    if (cls) el.className = 'dp-val ' + cls;
  };
  set('sc-spot', fmt$(CFG.spot));
  set('sc-mcap', fmtM(CFG.spot * circulatingSupply));
  set('sc-circ', (circulatingSupply / 1e6).toFixed(2) + 'M', 'dim');
  set('sc-ico', CFG.icoPrice ? fmt$(CFG.icoPrice) : '—', 'dim');

  // ── Health stats ──
  set('sc-burn', fmtBurn(burn) + '/mo', 'orange');
  set('sc-runway', monthsLeft + ' months');
  var ageMo = '—';
  if (CFG.launchDate) {
    ageMo = Math.floor((new Date() - new Date(CFG.launchDate)) / (30.44 * 24 * 60 * 60 * 1000)) + ' mo';
  }
  set('sc-age', ageMo, 'dim');

  // Since ICO perf
  if (CFG.icoPrice > 0 && CFG.spot > 0) {
    var sinceIco = ((CFG.spot - CFG.icoPrice) / CFG.icoPrice * 100);
    set('sc-chg-ico', (sinceIco >= 0 ? '+' : '') + sinceIco.toFixed(1) + '%', sinceIco >= 0 ? 'green' : 'red');
  }


  // ── Snap bar ──
  var snapNav = document.getElementById('snap-nav');
  if (snapNav) snapNav.textContent = strike > 0 ? fmt$(strike) : '—';
  var snapNavSub = document.getElementById('snap-nav-sub');
  if (snapNavSub) snapNavSub.textContent = fmtM(CFG.treasuryUSDC) + ' ÷ ' + (circulatingSupply/1e6).toFixed(2) + 'M';
  var snapTreas = document.getElementById('snap-treasury');
  if (snapTreas) snapTreas.textContent = fmtM(CFG.treasuryUSDC);
  var snapPnav = document.getElementById('snap-pnav');
  if (snapPnav && strike > 0) {
    var pnavPct = (isDiscount ? '' : '+') + discPct.toFixed(1) + '%';
    snapPnav.textContent = pnavPct;
    snapPnav.className = 'snap-value ' + (isDiscount ? 'below' : 'above');
  }
  var snapPnavSub = document.getElementById('snap-pnav-sub');
  if (snapPnavSub) snapPnavSub.textContent = isDiscount ? 'below floor' : 'above floor';
  var snapRunway = document.getElementById('snap-runway');
  if (snapRunway) snapRunway.textContent = monthsLeft + ' mo';
  var snapRunwaySub = document.getElementById('snap-runway-sub');
  if (snapRunwaySub) snapRunwaySub.textContent = fmtBurn(burn) + '/mo burn';

  return strike;
}

function renderNAVStats(candles, navPerToken) {
  var bar = document.getElementById('nav-stats-outer');
  if (!bar || !candles || candles.length === 0 || !navPerToken) { return; }

  var aboveDays = 0, belowDays = 0, tempAbove = 0, tempBelow = 0;
  var maxAbove = 0, maxBelow = 0;
  var abovePctSum = 0, belowPctSum = 0;
  for (var i = 0; i < candles.length; i++) {
    var p = candles[i].close || candles[i].price;
    var pct = (p - navPerToken) / navPerToken * 100;
    if (p >= navPerToken) { aboveDays++; abovePctSum += pct; tempAbove++; if (tempAbove > maxAbove) maxAbove = tempAbove; tempBelow = 0; }
    else { belowDays++; belowPctSum += Math.abs(pct); tempBelow++; if (tempBelow > maxBelow) maxBelow = tempBelow; tempAbove = 0; }
  }
  var total = aboveDays + belowDays;
  var abovePct = total > 0 ? (aboveDays / total * 100) : 0;
  var avgAbove = aboveDays > 0 ? (abovePctSum / aboveDays) : 0;
  var avgBelow = belowDays > 0 ? (belowPctSum / belowDays) : 0;
  var lastP = candles[candles.length - 1].close || candles[candles.length - 1].price;
  var isAboveNow = lastP >= navPerToken;
  var streak = 0;
  for (var j = candles.length - 1; j >= 0; j--) {
    var jp = candles[j].close || candles[j].price;
    if ((jp >= navPerToken) === isAboveNow) streak++;
    else break;
  }

  bar.innerHTML = '<div class="nav-stats-bar">' +
    '<div class="ns-item ns-above"><div class="ns-label">Above NAV</div><div class="ns-value">' + abovePct.toFixed(1) + '%</div><div class="ns-sub">' + aboveDays + '/' + total + ' periods · avg +' + avgAbove.toFixed(1) + '%</div><div class="ns-progress"><div class="ns-progress-fill" style="width:' + abovePct + '%;background:var(--green)"></div></div></div>' +
    '<div class="ns-item ns-below"><div class="ns-label">Below NAV</div><div class="ns-value">' + (100 - abovePct).toFixed(1) + '%</div><div class="ns-sub">' + belowDays + '/' + total + ' periods · avg -' + avgBelow.toFixed(1) + '%</div><div class="ns-progress"><div class="ns-progress-fill" style="width:' + (100 - abovePct) + '%;background:var(--red)"></div></div></div>' +
    '<div class="ns-item ns-neutral"><div class="ns-label">Current Streak</div><div class="ns-value">' + streak + 'd</div><div class="ns-sub">' + (isAboveNow ? 'trading above NAV' : 'trading below NAV') + '</div></div>' +
  '</div>';
}

function renderBalances() {
  var ticker = CFG.ticker || '';
  var fmtUsdc = function(n) {
    if (n === undefined || n === null || n === 0) return '';
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M USDC';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K USDC';
    if (n >= 100) return n.toFixed(0) + ' USDC';
    return '<$100 USDC';
  };
  var fmtTokens = function(n) {
    if (!n) return '0 ' + ticker;
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M ' + ticker;
    if (n >= 1e3) return (n / 1e3).toFixed(0) + 'K ' + ticker;
    return n.toLocaleString() + ' ' + ticker;
  };
  var balData = {
    dao:     { usdc: CFG.treasuryUSDC || 0, tokens: CFG.daoTokenBalance || 0 },
    futamm:  { usdc: CFG.futAmmUSDC || 0, tokens: CFG.futAmmTokens || 0 },
    metamm:  { usdc: CFG.metAmmUSDC || 0, tokens: CFG.metAmmTokens || 0 },
    lock:    { usdc: 0, tokens: CFG.lockTokenBalance || 0 },
    buyback: { usdc: 0, tokens: CFG.buybackTokenBalance || 0 },
  };
  document.querySelectorAll('.addr-bals').forEach(function(el) {
    var key = el.dataset.bal;
    if (!key) { el.innerHTML = '—'; return; }
    var d = balData[key] || { usdc: 0, tokens: 0 };
    var usdcStr = fmtUsdc(d.usdc);
    var tokenStr = fmtTokens(d.tokens);
    if (usdcStr) {
      el.innerHTML = '<span class="bal-usdc">' + usdcStr + '</span><span class="bal-sep">·</span><span class="bal-token">' + tokenStr + '</span>';
    } else {
      el.innerHTML = '<span class="bal-token">' + tokenStr + '</span>';
    }
  });
}

function renderAddresses() {
  var section = document.getElementById('addr-section');
  if (!section) return;
  var solscanUrl = function(addr, type) {
    return type === 'token' ? 'https://solscan.io/token/' + addr : 'https://solscan.io/account/' + addr;
  };
  var truncAddr = function(addr) { return addr.slice(0, 6) + '...' + addr.slice(-4); };
  var copyBtn = function(addr) {
    return '<button class="addr-copy" onclick="navigator.clipboard.writeText(\'' + addr + '\');this.textContent=\'Copied!\';this.classList.add(\'copied\');setTimeout(function(){this.textContent=\'Copy\';this.classList.remove(\'copied\')}.bind(this),1500)">Copy</button>';
  };
  var addrs = [];
  if (CFG.mint) addrs.push({ label: 'Token CA', addr: CFG.mint, type: 'token', balKey: null });
  if (CFG.daoWallet) addrs.push({ label: 'DAO Treasury', addr: CFG.daoWallet, type: 'account', balKey: 'dao' });
  if (CFG.ammWallet) addrs.push({ label: 'Fut AMM', addr: CFG.ammWallet, type: 'account', balKey: 'futamm' });
  if (CFG.ammWallet2) addrs.push({ label: 'Met AMM', addr: CFG.ammWallet2, type: 'account', balKey: 'metamm' });
  if (CFG.lockWallet) addrs.push({ label: 'Team Locked', addr: CFG.lockWallet, type: 'account', balKey: 'lock' });
  if (CFG.buybackWallet) addrs.push({ label: 'Buyback Wallet', addr: CFG.buybackWallet, type: 'account', balKey: 'buyback' });

  section.innerHTML = addrs.map(function(a) {
    return '<div class="addr-row">' +
      '<span class="addr-label">' + a.label + '</span>' +
      '<div class="addr-val"><a href="' + solscanUrl(a.addr, a.type) + '" target="_blank">' + truncAddr(a.addr) + '</a>' + copyBtn(a.addr) + '</div>' +
      '<div class="addr-bals" data-bal="' + (a.balKey || '') + '">—</div>' +
    '</div>';
  }).join('');
}

async function fetchAllowance() {
  try {
    var res = await fetch(API_BASE_DASH + '/api/allowance?token=' + tokenKey);
    var data = await res.json();
    if (data && !data.message) renderAllowance(data);
    else if (data && data.utilization && data.utilization.length > 0) renderAllowance(data);
  } catch(e) { console.error('Allowance fetch error:', e); }
}

function renderAllowance(data) {
  var section = document.getElementById('allowance-section');
  var cards = document.getElementById('allowance-cards');
  var history = document.getElementById('allowance-history');
  if (!section || !cards) return;
  section.style.display = 'block';

  var fmtK = function(v) { return v >= 1e6 ? '$' + (v/1e6).toFixed(1) + 'M' : v >= 1e3 ? '$' + (v/1e3).toFixed(0) + 'K' : '$' + v.toLocaleString(); };
  var fmtDate = function(d) {
    var parts = d.split('-');
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[parseInt(parts[1]) - 1] + ' ' + parseInt(parts[2]);
  };

  var subLabel = document.getElementById('allowance-sub-label');
  if (subLabel && data.monthlyAllowance) subLabel.textContent = fmtK(data.monthlyAllowance) + '/mo · ' + (data.schedule ? data.schedule.frequency : '') + ' schedule';

  var html = '';
  if (data.monthlyAllowance) html += '<div class="allowance-card"><div class="ac-label">Monthly Cap</div><div class="ac-value">' + fmtK(data.monthlyAllowance) + '</div><div class="ac-sub">' + (data.schedule ? data.schedule.frequency : '') + '</div></div>';
  if (data.avgUtilization != null) {
    var uc = data.avgUtilization > 100 ? 'var(--red)' : data.avgUtilization > 80 ? 'var(--orange)' : 'var(--green)';
    html += '<div class="allowance-card"><div class="ac-label">Avg Utilization</div><div class="ac-value" style="color:' + uc + '">' + data.avgUtilization + '%</div><div class="util-bar"><div class="util-fill" style="width:' + Math.min(100, data.avgUtilization) + '%;background:' + uc + '"></div></div></div>';
  }
  if (data.summary) html += '<div class="allowance-card"><div class="ac-label">Total Paid Out</div><div class="ac-value">' + fmtK(data.summary.totalPaidOut) + '</div><div class="ac-sub">' + data.summary.monthsLive + ' months live</div></div>';
  if (data.nextPredicted) {
    var np = data.nextPredicted;
    var st = np.overdue ? '<span style="color:var(--red)">' + Math.abs(np.daysUntil) + 'd overdue</span>' : '<span style="color:var(--green)">in ' + np.daysUntil + 'd</span>';
    html += '<div class="allowance-card"><div class="ac-label">Next Predicted</div><div class="ac-value">' + fmtDate(np.date) + '</div><div class="ac-sub">' + st + ' · ~' + fmtK(np.estimatedAmount) + '</div></div>';
  }
  if (data.lastPayment) {
    var lp = data.lastPayment;
    html += '<div class="allowance-card"><div class="ac-label">Last Payment</div><div class="ac-value">' + fmtDate(lp.date) + '</div><div class="ac-sub">' + lp.daysAgo + ' days ago · ' + fmtK(lp.amount) + '</div></div>';
  }
  cards.innerHTML = html;

  if (data.utilization && data.utilization.length > 0 && data.monthlyAllowance) {
    var utilHtml = '<div style="font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px">Monthly Breakdown</div>';
    data.utilization.forEach(function(u) {
      var pct = u.utilization || 0;
      var bc = pct > 100 ? 'var(--red)' : pct > 80 ? 'var(--orange)' : 'var(--green)';
      utilHtml += '<div class="allowance-month"><span class="am-label">' + u.month + '</span><span class="am-bar"><span class="am-fill" style="width:' + Math.min(100,pct) + '%;background:' + bc + '"></span></span><span class="am-pct">' + pct + '%</span><span style="color:var(--muted);margin-left:4px">' + fmtK(u.spent) + '</span></div>';
    });
    history.innerHTML = utilHtml;
  }

  if (data.specialPayments && data.specialPayments.length > 0) {
    var spHtml = '<div style="margin-top:12px;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px">Special Payments (governance)</div>';
    data.specialPayments.forEach(function(sp) { spHtml += '<div style="font-size:10px;color:var(--muted);padding:2px 0">' + fmtDate(sp.date) + ' — ' + fmtK(sp.amount) + '</div>'; });
    history.innerHTML += spHtml;
  }
}

// ── Main init ──
(async function main() {
  if (!CFG.live) {
    document.getElementById('token-title-name').textContent = CFG.name;
    document.getElementById('token-title-ticker').textContent = CFG.ticker + ' — Coming Soon';
    document.getElementById('price-hero-val').textContent = '—';
    return;
  }
  CFG.effectiveSupply = CFG.supply;

  document.getElementById('price-hero-val').textContent = '—';

  // Set token header immediately
  var iconEl = document.getElementById('token-icon');
  if (iconEl) {
    if (CFG.logo) iconEl.innerHTML = '<img src="' + CFG.logo + '" alt="' + CFG.ticker + '" style="width:100%;height:100%;object-fit:cover;display:block">';
    else iconEl.innerHTML = '<div style="width:100%;height:100%;background:' + (CFG.color||'#333') + ';border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:Syne,sans-serif;font-size:18px;font-weight:700;color:#fff">' + CFG.ticker.charAt(0) + '</div>';
  }
  document.getElementById('token-title-name').textContent = CFG.name;
  document.getElementById('token-title-ticker').textContent = CFG.ticker;

  renderAddresses();

  try {
    var results = await Promise.all([fetchOHLCV(), fetchFromAPI()]);
    var ohlcv = results[0], apiOk = results[1];
    var isLive = !!(ohlcv || apiOk);
    var navPerToken = renderUI(isLive);
    renderBalances();
    fetchAllowance();

    var chartData = (ohlcv && ohlcv.length > 0) ? ohlcv : [];
    if (apiOk && chartData.length > 0) {
      var lastC = chartData[chartData.length - 1];
      if (Math.abs(lastC.price - CFG.spot) > CFG.spot * 0.01) {
        chartData.push({ date: new Date(), open: lastC.price, high: Math.max(lastC.price, CFG.spot), low: Math.min(lastC.price, CFG.spot), close: CFG.spot, price: CFG.spot });
      }
    }

    var loadEl = document.getElementById('chart-loading');
    if (loadEl) loadEl.style.display = 'none';
    initChart(chartData, navPerToken);
    renderNAVStats(chartData, navPerToken);

    if (!ohlcv) {
      var notice = document.createElement('div');
      notice.style.cssText = 'text-align:center;font-size:9px;color:var(--orange);font-family:Inter,sans-serif;padding:6px 0';
      notice.textContent = '⚠ Chart data unavailable — price data could not be loaded.';
      var cc = document.getElementById('chart-container');
      cc.parentNode.insertBefore(notice, cc.nextSibling);
    }
  } catch(err) {
    console.error('NAVgator init error:', err);
    var loadEl2 = document.getElementById('chart-loading');
    if (loadEl2) loadEl2.remove();
    initChart([], 0);
  }
})();

} // end if (_hasToken)
</script>
</body>
</html>
