<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NAVgator · Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=DM+Serif+Display&family=JetBrains+Mono:wght@300;400;500&display=swap');
  :root {
    --bg: #0c0c10; --bg2: #141418; --bg3: #1a1a20;
    --border: #222228; --border2: #2a2a32;
    --dim: #555560; --muted: #77778a; --text: #a0a0b0; --bright: #d0d0dd; --white: #eeeef2;
    --green: #00e5a0; --green-dim: rgba(0,229,160,0.10);
    --red: #e84057; --orange: #f59e42; --blue: #5b8def; --purple: #9f8cfc;
    --card-bg: #16161c; --card-border: #24242c;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
  ::selection { background: rgba(0,229,160,0.25); }

  .wrap { max-width: 980px; margin: 0 auto; padding: 40px 32px 64px; }

  /* Nav bar */
  .nav { display: flex; align-items: center; gap: 16px; margin-bottom: 32px; flex-wrap: wrap; }
  .nav-brand { font-family: 'DM Serif Display', serif; font-size: 18px; font-weight: 400; color: var(--white); text-decoration: none; letter-spacing: -0.3px; display: flex; align-items: center; gap: 8px; }
  .nav-brand span { color: var(--green); }
  .nav-brand-icon { display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 6px; background: linear-gradient(135deg, var(--green), #00b880); font-family: 'DM Serif Display', serif; font-size: 13px; font-weight: 400; color: #0c0c10; flex-shrink: 0; }
  .nav-sep { color: var(--dim); }
  .nav-tokens { display: flex; gap: 6px; flex-wrap: wrap; }
  .nav-tok { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 500; letter-spacing: 0.8px; text-transform: uppercase; padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border2); color: var(--muted); text-decoration: none; transition: all 0.2s; }
  .nav-tok:hover { border-color: var(--green); color: var(--white); background: rgba(255,255,255,0.03); }
  .nav-tok.active { border-color: var(--green); color: var(--green); background: var(--green-dim); }

  /* Subheader line */
  .sub { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 500; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 10px; }
  .sub .data-tag { color: var(--green); }

  /* Title */
  h1 { font-family: 'DM Serif Display', serif; font-size: 42px; font-weight: 400; color: var(--white); margin-bottom: 12px; line-height: 1.1; letter-spacing: -0.5px; }

  /* Description */
  .desc { font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 400; color: var(--muted); line-height: 1.7; max-width: 740px; margin-bottom: 32px; }
  .desc b { color: var(--white); font-weight: 600; }
  .desc .hl-orange { color: var(--orange); font-weight: 600; }
  .desc .hl-green { color: var(--green); font-weight: 600; }

  /* 5 metric cards row */
  .cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 24px; }
  @media (max-width: 800px) { .cards { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 500px) { .cards { grid-template-columns: repeat(2, 1fr); } h1 { font-size: 30px; } }
  .card { border: 1px solid var(--card-border); border-radius: 12px; padding: 20px 22px; background: var(--card-bg); }
  .card-label { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 500; color: var(--muted); margin-bottom: 10px; }
  .card-value { font-family: 'DM Serif Display', serif; font-size: 32px; font-weight: 400; line-height: 1.1; color: var(--white); }
  .card-sub { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 400; color: var(--dim); margin-top: 6px; }

  /* Params bar */
  .params { display: flex; flex-wrap: wrap; gap: 6px 24px; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 400; color: var(--dim); padding: 14px 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); margin-bottom: 28px; }
  .params b { color: var(--text); font-weight: 600; }
  .params .hl { color: var(--green); font-weight: 600; }
  .params .spot { color: var(--red); font-weight: 600; }

  /* Chart section */
  .chart-section { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px; padding: 24px 20px 16px; margin-bottom: 28px; position: relative; }
  .chart-title { font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 500; color: var(--muted); margin-bottom: 16px; }
  .chart-title span { color: var(--red); }
  .chart-controls { display: flex; gap: 6px; position: absolute; top: 20px; right: 20px; z-index: 2; align-items: center; }
  .chart-btn-group { display: flex; gap: 4px; }
  .chart-btn-group + .chart-btn-group { margin-left: 8px; padding-left: 10px; border-left: 1px solid var(--border2); }
  .chart-btn { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 500; padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border2); color: var(--muted); background: transparent; cursor: pointer; transition: all 0.2s; }
  .chart-btn:hover { border-color: var(--green); color: var(--white); }
  .chart-btn.active { border-color: var(--green); color: var(--green); background: var(--green-dim); }
  #chart-container { width: 100%; min-height: 420px; position: relative; }
  .chart-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 12px; color: var(--dim); }

  /* Tooltip */
  .chart-tooltip { position: absolute; display: none; pointer-events: none; background: rgba(12,12,16,0.96); border: 1px solid var(--card-border); border-radius: 10px; padding: 12px 16px; z-index: 10; backdrop-filter: blur(8px); }
  .tt-price { font-family: 'DM Serif Display', serif; font-size: 22px; font-weight: 400; color: var(--white); margin-bottom: 4px; }
  .tt-line { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 400; margin-top: 3px; }
  .tt-date { font-family: 'Inter', sans-serif; font-size: 10px; color: var(--dim); margin-top: 6px; }

  /* Legend */
  .legend { display: flex; flex-wrap: wrap; gap: 18px; padding: 12px 4px 0; font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 400; color: var(--muted); }
  .legend-item { display: flex; align-items: center; gap: 6px; }
  .legend-line { display: inline-block; width: 18px; height: 2.5px; border-radius: 2px; }
  .legend-fill { display: inline-block; width: 12px; height: 12px; border-radius: 2px; }
  .legend-dash { display: inline-block; width: 16px; height: 0; border-top: 2px dashed; }

  /* Address section */
  .nav-stats-bar { display: flex; gap: 0; margin-top: 12px; border-radius: 10px; overflow: hidden; font-family: 'Inter', sans-serif; font-size: 12px; }
  .nav-stats-bar .ns-item { flex: 1; padding: 12px 16px; display: flex; flex-direction: column; gap: 4px; }
  .nav-stats-bar .ns-label { font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; opacity: 0.7; }
  .nav-stats-bar .ns-value { font-size: 16px; font-weight: 600; }
  .nav-stats-bar .ns-sub { font-size: 10px; opacity: 0.6; }
  .nav-stats-bar .ns-above { background: rgba(0,229,160,0.08); color: #00e5a0; }
  .nav-stats-bar .ns-below { background: rgba(232,64,87,0.08); color: #e84057; }
  .nav-stats-bar .ns-neutral { background: rgba(255,255,255,0.04); color: var(--muted); }
  .nav-stats-bar .ns-progress { height: 4px; border-radius: 2px; margin-top: 6px; background: rgba(255,255,255,0.06); overflow: hidden; }
  .nav-stats-bar .ns-progress-fill { height: 100%; border-radius: 2px; }

  .addr-section { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px; padding: 20px 22px; margin-bottom: 28px; }
  .addr-title { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 600; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 14px; }
  .addr-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-family: 'Inter', sans-serif; font-size: 12px; }
  .addr-row:last-child { border-bottom: none; }
  .addr-label { color: var(--muted); font-weight: 500; min-width: 100px; }
  .addr-val { display: flex; align-items: center; gap: 8px; }
  .addr-val a { color: var(--green); text-decoration: none; font-family: 'JetBrains Mono', monospace; font-size: 11px; }
  .addr-val a:hover { text-decoration: underline; }
  .addr-copy { background: none; border: 1px solid var(--border2); border-radius: 4px; color: var(--dim); font-size: 10px; padding: 2px 6px; cursor: pointer; transition: all 0.2s; font-family: 'Inter', sans-serif; }
  .addr-copy:hover { border-color: var(--green); color: var(--green); }
  .addr-copy.copied { border-color: var(--green); color: var(--green); }

  .footer { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 400; color: var(--dim); text-align: center; padding: 24px 0; border-top: 1px solid var(--border); }
  .footer a { color: var(--muted); text-decoration: underline; }

  /* ── Landing page styles ── */
  .landing { display: none; }
  .landing.active { display: block; }
  .dashboard { display: none; }
  .dashboard.active { display: block; }
  .hero { padding: 80px 0 48px; text-align: center; }
  .logo-mark { display: inline-flex; align-items: center; justify-content: center; width: 64px; height: 64px; border-radius: 16px; background: linear-gradient(135deg, var(--green), #00b880); font-family: 'DM Serif Display', serif; font-size: 30px; font-weight: 400; color: #0c0c10; margin-bottom: 24px; box-shadow: 0 0 60px rgba(0,229,160,0.15), 0 0 120px rgba(0,229,160,0.05); animation: float 6s ease-in-out infinite; position: relative; }
  .logo-mark::after { content: ''; position: absolute; inset: -1px; border-radius: 17px; background: linear-gradient(135deg, rgba(0,229,160,0.4), rgba(0,184,128,0.1)); z-index: -1; filter: blur(1px); }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
  .hero h1 { font-family: 'DM Serif Display', serif; font-size: 52px; font-weight: 400; color: var(--white); line-height: 1.1; margin-bottom: 14px; letter-spacing: -1px; }
  .hero h1 span { color: var(--green); }
  .tagline { font-family: 'Inter', sans-serif; font-size: 15px; font-weight: 400; color: var(--muted); line-height: 1.7; max-width: 540px; margin: 0 auto 40px; }
  .sort-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .sort-label { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 500; letter-spacing: 1.5px; text-transform: uppercase; color: var(--dim); }
  .sort-btn { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 500; padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border2); color: var(--muted); background: transparent; cursor: pointer; transition: all 0.2s; }
  .sort-btn:hover { border-color: var(--green); color: var(--white); background: rgba(255,255,255,0.03); }
  .sort-btn.active { border-color: var(--green); color: var(--green); background: var(--green-dim); }
  .tokens { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 14px; margin-bottom: 48px; }
  .token-card { border: 1px solid var(--card-border); border-radius: 14px; padding: 24px 22px; background: var(--card-bg); text-decoration: none; color: inherit; transition: all 0.25s ease; position: relative; overflow: hidden; }
  .token-card:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(0,229,160,0.06); border-color: var(--border2); }
  .tc-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; position: relative; }
  .tc-icon { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'DM Serif Display', serif; font-size: 16px; font-weight: 400; color: #0c0c10; flex-shrink: 0; }
  .tc-name { font-family: 'DM Serif Display', serif; font-size: 18px; font-weight: 400; color: var(--white); }
  .tc-pair { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 400; color: var(--dim); margin-top: 2px; }
  .tc-arrow { position: absolute; top: 0; right: 0; font-size: 16px; color: var(--dim); transition: all 0.25s; }
  .token-card:hover .tc-arrow { color: var(--green); transform: translateX(3px); }
  .tc-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; position: relative; }
  .tc-stat-label { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 500; color: var(--muted); }
  .tc-stat-val { font-family: 'DM Serif Display', serif; font-size: 16px; font-weight: 400; margin-top: 2px; }
  .how { padding: 36px 0 48px; border-top: 1px solid var(--border); }
  .how h2 { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--dim); margin-bottom: 24px; }
  .how-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
  @media (max-width: 600px) { .how-grid { grid-template-columns: 1fr; } .hero h1 { font-size: 36px; } }
</style>
</head>
<body>

<div class="wrap">

  <!-- ══ LANDING PAGE ══ -->
  <div class="landing" id="landing-view">
    <div class="hero">
      <div class="logo-mark" style="background:transparent;box-shadow:none"><svg width="48" height="30" viewBox="0 0 160 100"><ellipse cx="80" cy="50" rx="55" ry="30" fill="none" stroke="#00e5a0" stroke-width="5"/><ellipse cx="80" cy="50" rx="7" ry="26" fill="#00e5a0"/></svg></div>
      <h1>NAV<span>gator</span></h1>
      <p class="tagline">Real-time NAV analytics for MetaDAO ownership tokens. Treasury tracking, discount/premium metrics, and live on-chain data.</p>
    </div>
    <div class="sort-bar" id="sort-bar">
      <span class="sort-label">Sort by</span>
      <button class="sort-btn active" data-sort="mcap">MCap</button>
      <button class="sort-btn" data-sort="treasury">Treasury</button>
      <button class="sort-btn" data-sort="discount">Discount</button>
    </div>
    <div class="tokens" id="tokens"></div>
    <div class="how">
      <h2>How Treasury Backing Works</h2>
      <div class="how-grid">
        <div class="how-item"><div class="how-num" style="font-size:12px;font-weight:600;color:var(--green);margin-bottom:6px">01</div><div style="font-size:13px;color:var(--white);font-weight:600;margin-bottom:5px">Treasury-backed tokens</div><div style="font-size:12px;color:var(--muted);line-height:1.6">MetaDAO ICOs deposit all raised USDC into an on-chain treasury. The team draws a fixed monthly budget — every dollar is governed by futarchy.</div></div>
        <div class="how-item"><div class="how-num" style="font-size:12px;font-weight:600;color:var(--green);margin-bottom:6px">02</div><div style="font-size:13px;color:var(--white);font-weight:600;margin-bottom:5px">Backing = Treasury ÷ Supply</div><div style="font-size:12px;color:var(--muted);line-height:1.6">Each token has a claim on treasury USDC. When spot trades below backing, you're buying below the treasury floor — dissolution returns more than market price.</div></div>
        <div class="how-item"><div class="how-num" style="font-size:12px;font-weight:600;color:var(--green);margin-bottom:6px">03</div><div style="font-size:13px;color:var(--white);font-weight:600;margin-bottom:5px">Dissolution right</div><div style="font-size:12px;color:var(--muted);line-height:1.6">Any holder can propose dissolution via futarchy. If passed, treasury distributes pro-rata. This creates a soft price floor enforced by rational arbitrage.</div></div>
      </div>
    </div>
    <div class="footer">NAVgator · Treasury analytics for ownership tokens · <a href="https://metadao.fi" target="_blank">MetaDAO</a> · Data via NAVgator API + Birdeye + Solana RPC · Not financial advice</div>
  </div>

  <!-- ══ DASHBOARD VIEW ══ -->
  <div class="dashboard" id="dashboard-view">

  <!-- Nav -->
  <nav class="nav" id="nav"></nav>

  <div class="sub" id="sub-line">LOADING…</div>
  <h1 id="title">Loading Dashboard…</h1>
  <div class="desc" id="desc">Fetching data…</div>

  <div class="cards" id="cards"></div>
  <div class="params" id="params"></div>

  <div class="chart-section">
    <div class="chart-title" id="chart-label"></div>
    <div class="chart-controls" id="chart-controls">
      <div class="chart-btn-group" id="chart-view-toggle">
        <button class="chart-btn active" data-view="nav">Line</button>
        <button class="chart-btn" data-view="candle">Candle</button>
      </div>
      <div class="chart-btn-group">
        <button class="chart-btn" data-tf="12H">12H</button>
        <button class="chart-btn active" data-tf="1D">1D</button>
        <button class="chart-btn" data-tf="1W">1W</button>
        <button class="chart-btn" data-tf="1M">1M</button>
      </div>
    </div>
    <div id="chart-container">
      <div class="chart-loading" id="chart-loading">⏳ Fetching price history…</div>
    </div>
    <div class="legend">
      <span class="legend-item"><span class="legend-fill" style="background:#00e5a0"></span> <span id="leg-spot-label">Bullish</span></span>
      <span class="legend-item"><span class="legend-fill" style="background:#e84057"></span> Bearish</span>
      <span class="legend-item"><span class="legend-line" style="background:#e84057"></span> NAV <span id="leg-strike">…</span></span>
    </div>
    <div class="nav-stats-bar" id="nav-stats-bar"></div>
  </div>

  <!-- Address section -->
  <div class="addr-section" id="addr-section"></div>

  <div class="footer">
    <a href="index.html">← NAVgator Home</a> · Treasury analytics for ownership tokens · Chart by <a href="https://www.tradingview.com/" target="_blank">TradingView</a> · Not financial advice
  </div>

  </div><!-- /dashboard-view -->
</div><!-- /wrap -->

<script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>
<script>
// ═══════════════════════════════════════════════════════════════════════
// VIEW ROUTING — landing page vs dashboard
// ═══════════════════════════════════════════════════════════════════════
const _params = new URLSearchParams(window.location.search);
const _hasToken = _params.has('token');

if (_hasToken) {
  document.getElementById('dashboard-view').classList.add('active');
  document.title = 'NAVgator · Dashboard';
} else {
  document.getElementById('landing-view').classList.add('active');
  document.title = 'NAVgator — Treasury Analytics for Ownership Tokens';
}

// ═══════════════════════════════════════════════════════════════════════
// TOKEN CONFIGS
// ═══════════════════════════════════════════════════════════════════════
const TOKENS = {
  solo: { live: true,
    name: 'Solomon', ticker: 'SOLO', pair: 'SOLO/USDC',
    color: '#00e5a0',
    mint: 'SoLo9oxzLDpcq1dpqAgMwgce5WqkRDtNXK7EPnbmeta',
    usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    daoWallet: '98SPcyUZ2rqM2dgjCqqSXS4gJrNTLSNUAAVCF38xYj9u',
    ammWallet: 'DzYtzoNvPbyFCzwZA6cSm9eDEEmxEB9f8AGkJXUXgnSA',
    ammWallet2: '2zsbECzM7roqnDcuv2TNGpfv5PAnuqGmMo5YPtqmUz5p',
    lockWallet: 'Bo24B7DDVtpa9VxZ4LN8FrAT7TM3cgkri41a5GjFg5Dk',
    gtPool: 'o5rJFXSKTsuws58rBMNPG8jdKdnY4Z7ouU29dyohE4g',
    raise: 8_000_000, supply: 10_000_000, icoPrice: 0.80, ath: 1.09,
    monthlyBurn: 100_000, realizedVol: 99, tradingDays: 85,
    genesisStrike: 0.62, genesisPut: 0.300,
    spot: 0.55, treasuryUSDC: 7_420_000, ammUSDCFixed: null,
    tge: '2025-11-18',
    draws: [
      { date: '2025-12-01', amount: 100_000, label: 'Draw #1' },
      { date: '2026-01-01', amount: 100_000, label: 'Draw #2' },
      { date: '2026-02-01', amount: 100_000, label: 'Draw #3' },
    ],
    fallback: { peakDay: 1, peakPrice: 1.09, bounceDay: 30, bouncePrice: 0.70, listPrice: 0.94, floor: 0.40 },
  },
  zkfg: { live: true,
    name: 'ZKLSOL', ticker: 'ZKFG', pair: 'ZKFG/USDC',
    color: '#9f8cfc',
    mint: 'ZKFHiLAfAFMTcDAuCtjNW54VzpERvoe7PBF9mYgmeta',
    usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    daoWallet: 'BNvDfXYG2FAyBDYD71Xr9GhKE18MbmhtjsLKsCuXho6z',
    ammWallet: '5FPGRzY9ArJFwY2Hp2y2eqMzVewyWCBox7esmpuZfCvE',
    gtPool: 'JDuK4Wp3MQM6d9QKDNDNgoELHkfAMSqbbqzbmkz19vis',
    raise: 970_000, supply: 10_000_000, icoPrice: 0.097, ath: 0.145,
    monthlyBurn: 50_000, realizedVol: 120, tradingDays: 107,
    genesisStrike: 0.097, genesisPut: 0.055,
    spot: 0.0654, treasuryUSDC: 820_000, ammUSDCFixed: null,
    tge: '2025-10-24',
    draws: [
      { date: '2025-11-24', amount: 50_000, label: 'Draw #1' },
      { date: '2025-12-24', amount: 50_000, label: 'Draw #2' },
      { date: '2026-01-24', amount: 50_000, label: 'Draw #3' },
    ],
    fallback: { peakDay: 14, peakPrice: 0.145, bounceDay: 45, bouncePrice: 0.09, listPrice: 0.0687, floor: 0.02 },
  },
  umbra: { live: true,
    name: 'Umbra', ticker: 'UMBRA', pair: 'UMBRA/USDC',
    color: '#00c2ff',
    mint: 'PRVT6TB7uss3FrUd2D9xs2zqDBsa3GbMJMwCQsgmeta',
    usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    daoWallet: '6VsC8PuKkXm5xo54c2vbrAaSfQipkpGHqNuKTxXFySx6',
    ammWallet: 'BLkBSE96kQys7SrMioKxeMiVbeo4Ckk2Y4n1JphKxYnv',
    ammWallet2: '7dVri3qjYD3uobSZL3Zth8vSCgU6r6R2nvFsh7uVfDte',
    lockWallet: '3kX3EWm9iPB6oxFS2NJ71L6v5wzFZ8rQMEG6HC8QHJtF',
    gtPool: '7dVri3qjYD3uobSZL3Zth8vSCgU6r6R2nvFsh7uVfDte',
    gtPoolLegacy: 'BLkBSE96kQys7SrMioKxeMiVbeo4Ckk2Y4n1JphKxYnv',
    raise: 3_000_000, supply: 10_000_000, icoPrice: 0.30, ath: 2.43,
    monthlyBurn: 34_000, realizedVol: 110, tradingDays: 122,
    genesisStrike: 0.24, genesisPut: 0.12,
    spot: 0.76, treasuryUSDC: 2_860_000, ammUSDCFixed: null,
    tge: '2025-10-10',
    draws: [
      { date: '2025-11-10', amount: 34_000, label: 'Draw #1' },
      { date: '2025-12-10', amount: 34_000, label: 'Draw #2' },
      { date: '2026-01-10', amount: 34_000, label: 'Draw #3' },
      { date: '2026-02-10', amount: 34_000, label: 'Draw #4' },
    ],
    fallback: { peakDay: 3, peakPrice: 2.43, bounceDay: 30, bouncePrice: 1.10, listPrice: 2.31, floor: 0.30 },
  },
  avici: { live: true,
    name: 'Avici', ticker: 'AVICI', pair: 'AVICI/USDC',
    color: '#ff6b9d',
    mint: 'BANKJmvhT8tiJRsBSS1n2HryMBPvT5Ze4HU95DUAmeta',
    usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    daoWallet: 'DGgYoUcu1aDZt4GEL5NQiducwHRGbkMWsUzsXh2j622G',
    ammWallet: '3D854kknnQhu9xVaRNV154oZ9oN2WF3tXsq3LDu7fFMn',
    ammWallet2: '5gB4NPgFB3MHFHSeKN4sbaY6t9MB8ikCe9HyiKYid4Td',
    gtPool: '5gB4NPgFB3MHFHSeKN4sbaY6t9MB8ikCe9HyiKYid4Td',
    gtPoolLegacy: '3D854kknnQhu9xVaRNV154oZ9oN2WF3tXsq3LDu7fFMn',
    raise: 3_500_000, supply: 12_900_000, icoPrice: 0.35, ath: 7.57,
    monthlyBurn: 45_000, realizedVol: 130, tradingDays: 114,
    genesisStrike: 0.22, genesisPut: 0.11,
    spot: 1.08, treasuryUSDC: 3_300_000, ammUSDCFixed: null,
    tge: '2025-10-18',
    draws: [
      { date: '2025-11-18', amount: 45_000, label: 'Draw #1' },
      { date: '2025-12-18', amount: 45_000, label: 'Draw #2' },
      { date: '2026-01-18', amount: 45_000, label: 'Draw #3' },
    ],
    fallback: { peakDay: 40, peakPrice: 7.57, bounceDay: 70, bouncePrice: 3.50, listPrice: 0.50, floor: 0.45 },
  },
  loyal: { live: true,
    name: 'Loyal', ticker: 'LOYAL', pair: 'LOYAL/USDC',
    color: '#ffd700',
    mint: 'LoyALuiy1mRSpjRBRw3iCp88T7xSD4kxTL6uYdpAmeta',
    usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    daoWallet: 'AQyyTwCKemeeMu8ZPZFxrXMbVwAYTSbBhi1w4PBrhvYE',
    ammWallet: 'GxpJkPEsPmuRCCTNnfZaDKg4X3gf4ZPgmqgFqtibaPtK',
    ammWallet2: 'BGg7WsK98rhqtTp2uSKMa2yETqgwShFAjyf1RmYqCF7n',
    buybackWallet: 'AfGAjj7TQByC2WQtCNRhsyq1WeZqmQ7oNRoGb2JbgoQg',
    gtPool: 'BGg7WsK98rhqtTp2uSKMa2yETqgwShFAjyf1RmYqCF7n',
    gtPoolLegacy: 'GxpJkPEsPmuRCCTNnfZaDKg4X3gf4ZPgmqgFqtibaPtK',
    raise: 500_000, supply: 10_000_000, icoPrice: 0.05, ath: 0.37,
    monthlyBurn: 45_000, realizedVol: 140, tradingDays: 114,
    genesisStrike: 0.038, genesisPut: 0.02,
    spot: 0.13, treasuryUSDC: 420_000, ammUSDCFixed: null,
    tge: '2025-10-23',
    draws: [
      { date: '2025-11-23', amount: 45_000, label: 'Draw #1' },
      { date: '2025-12-23', amount: 45_000, label: 'Draw #2' },
      { date: '2026-01-23', amount: 45_000, label: 'Draw #3' },
    ],
    fallback: { peakDay: 1, peakPrice: 0.37, bounceDay: 40, bouncePrice: 0.15, listPrice: 0.09, floor: 0.03 },
  },
  paystream: { live: false,
    name: 'Paystream', ticker: 'PAY', pair: 'PAY/USDC',
    color: '#44ddaa',
    mint: '',
    usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    daoWallet: 'BpXtB2ASf2Tft97ewTd8PayXCqFQ6Wqod33qrwwfK9Vz',
    ammWallet: '6FRXzTe3HajL8Fwmmkupp8g3y3wn3g3QEjj8sABndre3',
    ammWallet2: '6F88Y6iukU9GuL8CMWnx6YT832vBymNPicJBikQWeYe4',
    buybackWallet: '3BAUsXfhhK2H1KH18GYNhUvLUsPrKWcePEA5N2UKP6VL',
    gtPool: '6F88Y6iukU9GuL8CMWnx6YT832vBymNPicJBikQWeYe4',
    gtPoolLegacy: '6FRXzTe3HajL8Fwmmkupp8g3y3wn3g3QEjj8sABndre3',
    raise: 300_000, supply: 10_000_000, icoPrice: 0.03, ath: 0.04,
    monthlyBurn: 15_000, realizedVol: 100, tradingDays: 100,
    genesisStrike: 0.024, genesisPut: 0.012,
    spot: 0.021, treasuryUSDC: 255_000, ammUSDCFixed: null,
    tge: '2025-10-27',
    draws: [
      { date: '2025-11-27', amount: 15_000, label: 'Draw #1' },
      { date: '2025-12-27', amount: 15_000, label: 'Draw #2' },
      { date: '2026-01-27', amount: 15_000, label: 'Draw #3' },
    ],
    fallback: { peakDay: 10, peakPrice: 0.04, bounceDay: 35, bouncePrice: 0.028, listPrice: 0.03, floor: 0.01 },
  },
  omfg: { live: true,
    name: 'Omnipair', ticker: 'OMFG', pair: 'OMFG/USDC',
    color: '#ff8855',
    mint: 'omfgRBnxHsNJh6YeGbGAmWenNkenzsXyBXm3WDhmeta',
    usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    daoWallet: '34rned2SLUcYjUrM9meQkuyJY4QDBcKhkcUPXCgGuXD9',
    ammWallet: '2WNhaB6TPyZ3ynJjAUM4ZZ1Hdeep8FJ3A76FjGjTVjjS',
    ammWallet2: 'BiNnErm2VDkbKGiABj9ZRUjybz879NhH2heeWE7m5M6d',
    gtPool: 'BiNnErm2VDkbKGiABj9ZRUjybz879NhH2heeWE7m5M6d',
    gtPoolLegacy: '2WNhaB6TPyZ3ynJjAUM4ZZ1Hdeep8FJ3A76FjGjTVjjS',
    raise: 500_000, supply: 10_000_000, icoPrice: 0.05, ath: 0.83,
    monthlyBurn: 25_000, realizedVol: 120, tradingDays: 130,
    genesisStrike: 0.04, genesisPut: 0.02,
    spot: 0.32, treasuryUSDC: 400_000, ammUSDCFixed: null,
    tge: '2025-07-28',
    draws: [
      { date: '2025-11-02', amount: 25_000, label: 'Draw #1' },
      { date: '2025-12-02', amount: 25_000, label: 'Draw #2' },
      { date: '2026-01-02', amount: 25_000, label: 'Draw #3' },
      { date: '2026-02-02', amount: 25_000, label: 'Draw #4' },
    ],
    fallback: { peakDay: 21, peakPrice: 0.83, bounceDay: 50, bouncePrice: 0.50, listPrice: 0.08, floor: 0.04 },
  },
  meta: { live: false,
    name: 'MetaDAO', ticker: 'META', pair: 'META/USDC',
    color: '#ff5533',
    mint: 'METAwkXcqyXKy1AtsSgJ8JiUHwGCafnZL38n3vYmeta',
    usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    daoWallet: 'BfzJzFUeE54zv6Q2QdAZR4yx7UXuYRsfkeeirrRcxDvk',
    ammWallet: 'CUPoiqkK4hxyCiJcLC4yE9AtJP1MoV1vFV2vx3jqwWeS',
    ammWallet2: 'EXpXkwcWDhjEYyC5pfNfxsu8fUtK4CDCYTZR4ApQNRzo',
    gtPool: 'EXpXkwcWDhjEYyC5pfNfxsu8fUtK4CDCYTZR4ApQNRzo',
    gtPoolLegacy: 'CUPoiqkK4hxyCiJcLC4yE9AtJP1MoV1vFV2vx3jqwWeS',
    raise: 0, supply: 22_080_000, icoPrice: 0.17, ath: 10.69,
    monthlyBurn: 0, realizedVol: 95, tradingDays: 300,
    genesisStrike: 0, genesisPut: 0,
    spot: 3.78, treasuryUSDC: 0, ammUSDCFixed: null,
    tge: '2025-04-09',
    draws: [],
    fallback: { peakDay: 140, peakPrice: 10.69, bounceDay: 200, bouncePrice: 5.50, listPrice: 0.50, floor: 0.10 },
    note: 'Platform token — no ICO treasury structure. Treasury analytics are approximate.',
  },
  rngr: { live: true,
    name: 'Ranger', ticker: 'RNGR', pair: 'RNGR/USDC',
    color: '#22dd88',
    mint: 'RNGRtJMbCveqCp7AC6U95KmrdKecFckaJZiWbPGmeta',
    usdcMint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    daoWallet: '55H1Q1YrHJQ93uhG4jqrBBHx3a8H7TCM8kvf2UM2g5q3',
    ammWallet: '1PAwyDkWNFCcR96GhEReXHJBv3YEFVazCaQgNicVuKv',
    ammWallet2: '59WuweKV7DAg8aUgRhNytScQxioaFYNJdWnox5FxAXFq',
    buybackWallet: '33AEddb7BxoA7Y65BzybFCV5WyGy7LfBdjiL2anCDEkr',
    lockWallet: 'F35JE1HZMtZXXWdy3koSPRe1gGFQyqd5kpbPw2xNcjR8',
    gtPool: '59WuweKV7DAg8aUgRhNytScQxioaFYNJdWnox5FxAXFq',
    gtPoolLegacy: '1PAwyDkWNFCcR96GhEReXHJBv3YEFVazCaQgNicVuKv',
    raise: 8_000_000, supply: 10_000_000, icoPrice: 0.60, ath: 0.865,
    monthlyBurn: 250_000, realizedVol: 90, tradingDays: 32,
    genesisStrike: 0.47, genesisPut: 0.18,
    spot: 0.54, treasuryUSDC: 5_750_000, ammUSDCFixed: null,
    tge: '2026-01-10',
    draws: [
      { date: '2026-02-10', amount: 250_000, label: 'Draw #1' },
    ],
    fallback: { peakDay: 1, peakPrice: 0.865, bounceDay: 15, bouncePrice: 0.55, listPrice: 0.81, floor: 0.40 },
  },
};
// ═══════════════════════════════════════════════════════════════════════
// LANDING PAGE LOGIC
// ═══════════════════════════════════════════════════════════════════════
if (!_hasToken) {
  const landingTokens = Object.entries(TOKENS).map(([key, t]) => ({
    key, name: t.ticker, desc: t.name + (t.pair ? ' · ' + t.pair.split('/')[0] : ''),
    color: t.color, spot: t.spot, strike: t.raise > 0 ? t.treasuryUSDC / t.supply : 0,
    treasury: t.treasuryUSDC, mcap: t.spot * t.supply, live: t.live,
  }));
  const lfmt$ = (n) => '$' + (n >= 1 ? n.toFixed(2) : n >= 0.01 ? n.toFixed(4) : n.toFixed(6));
  const lfmtM = n => n>=1e6?'$'+(n/1e6).toFixed(1)+'M':'$'+(n/1e3).toFixed(0)+'K';

  function renderTokens(sortKey) {
    const sorted = [...landingTokens].sort((a, b) => {
      if (sortKey === 'treasury') return b.treasury - a.treasury;
      if (sortKey === 'discount') {
        const da = a.strike > 0 ? (a.strike - a.spot) / a.strike : -999;
        const db = b.strike > 0 ? (b.strike - b.spot) / b.strike : -999;
        return db - da;
      }
      return b.mcap - a.mcap;
    });
    document.getElementById('tokens').innerHTML = sorted.map(t => {
      const noStrike = t.strike === 0;
      const discPct = t.strike > 0 ? ((t.spot - t.strike) / t.strike * 100) : 0;
      const isDiscount = discPct < 0;
      const fmtMcap = t.mcap >= 1e6 ? '$'+(t.mcap/1e6).toFixed(1)+'M' : '$'+(t.mcap/1e3).toFixed(0)+'K';
      const discLabel = noStrike ? 'N/A' : isDiscount ? Math.abs(discPct).toFixed(1) + '% discount' : '+' + discPct.toFixed(0) + '% premium';
      const comingSoon = !t.live;
      const overlay = comingSoon ? '<div style="position:absolute;inset:0;background:rgba(12,12,16,0.82);border-radius:14px;display:flex;align-items:center;justify-content:center;z-index:2"><span style="font-size:12px;font-weight:600;color:var(--muted);letter-spacing:1px;text-transform:uppercase">Coming Soon</span></div>' : '';
      return `<a class="token-card" ${comingSoon?'style="pointer-events:none"':'href="index.html?token='+t.key+'"'} onmouseover="this.style.borderColor='${t.color}'" onmouseout="this.style.borderColor=''">
        ${overlay}
        <div class="tc-header">
          <div class="tc-icon" style="background:${t.color}">${t.name[0]}</div>
          <div><div class="tc-name">${t.name}</div><div class="tc-pair">${t.desc}</div></div>
          <span class="tc-arrow">→</span>
        </div>
        <div class="tc-stats">
          <div><div class="tc-stat-label">Spot</div><div class="tc-stat-val" style="color:var(--white)">${lfmt$(t.spot)}</div></div>
          <div><div class="tc-stat-label">MCap</div><div class="tc-stat-val" style="color:var(--text)">${fmtMcap}</div></div>
          <div><div class="tc-stat-label">${noStrike?'—':'Backing'}</div><div class="tc-stat-val" style="color:#e84057">${noStrike?'N/A':lfmt$(t.strike)}</div></div>
          <div><div class="tc-stat-label">vs NAV</div><div class="tc-stat-val" style="color:${isDiscount?'var(--red)':'var(--green)'}">${discLabel}</div></div>
        </div>
      </a>`;
    }).join('');
  }

  renderTokens('mcap');
  document.getElementById('sort-bar').addEventListener('click', e => {
    const btn = e.target.closest('.sort-btn');
    if (!btn) return;
    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderTokens(btn.dataset.sort);
  });

  // Fetch live data from backend API
  const API_BASE = 'https://navgator-api.vercel.app';
  const currentSort = () => document.querySelector('.sort-btn.active')?.dataset.sort || 'mcap';

  async function fetchLandingData() {
    try {
      const res = await fetch(API_BASE + '/api/current');
      const data = await res.json();
      if (!data.tokens) return;
      for (const t of data.tokens) {
        if (t.error) continue;
        const lt = landingTokens.find(x => x.key === t.token);
        if (!lt) continue;
        if (t.spot > 0) { lt.spot = t.spot; lt.mcap = t.spot * (t.effectiveSupply || TOKENS[t.token].supply); }
        if (t.treasuryUSDC > 0 && t.effectiveSupply > 0) { lt.treasury = t.treasuryUSDC; lt.strike = t.treasuryUSDC / t.effectiveSupply; }
      }
      renderTokens(currentSort());
      console.log('NAVgator landing: live data loaded from API');
    } catch (e) { console.warn('API fetch failed:', e.message); }
  }

  fetchLandingData();
}

// ═══════════════════════════════════════════════════════════════════════
// DASHBOARD LOGIC (only when ?token= is present)
// ═══════════════════════════════════════════════════════════════════════
if (_hasToken) {
const params = new URLSearchParams(window.location.search);
const tokenKey = (params.get('token') || 'solo').toLowerCase();
const CFG = TOKENS[tokenKey] || TOKENS.solo;
const API_BASE_DASH = 'https://navgator-api.vercel.app';

document.title = `NAVgator · ${CFG.ticker}/USDC — Treasury Analytics`;

// Build nav — dim non-live tokens
const navEl = document.getElementById('nav');
const LIVE_KEYS = new Set(Object.entries(TOKENS).filter(([k,v]) => v.live).map(([k]) => k));
let navHTML = '<a href="index.html" class="nav-brand"><svg width="22" height="14" viewBox="0 0 160 100" style="flex-shrink:0"><ellipse cx="80" cy="50" rx="55" ry="30" fill="none" stroke="#00e5a0" stroke-width="6"/><ellipse cx="80" cy="50" rx="7" ry="26" fill="#00e5a0"/></svg> NAV<span>gator</span></a><span class="nav-sep">·</span><div class="nav-tokens">';
for (const [key, tok] of Object.entries(TOKENS)) {
  const isLive = LIVE_KEYS.has(key);
  const dimStyle = !isLive ? 'opacity:0.35;pointer-events:none;' : '';
  navHTML += `<a class="nav-tok${key===tokenKey?' active':''}" href="index.html?token=${key}" style="${dimStyle}${key===tokenKey?'border-color:'+tok.color+';color:'+tok.color:''}">${tok.ticker}</a>`;
}
navHTML += '</div>';
navEl.innerHTML = navHTML;

// If token is not live, show coming soon overlay and stop
if (!CFG.live) {
  document.getElementById('sub-line').textContent = 'COMING SOON';
  document.getElementById('title').textContent = CFG.name + ' — Coming Soon';
  document.getElementById('desc').innerHTML = `<b>${CFG.ticker}</b> dashboard is under development. Treasury tracking, price charts, and analytics will be available soon.`;
  document.getElementById('cards').innerHTML = '';
  document.getElementById('params').innerHTML = '';
  document.getElementById('chart-loading').textContent = 'Coming Soon';
  const scs = document.getElementById('strike-chart-section');
  if (scs) scs.style.display = 'none';
}

// ═══════════════════════════════════════════════════════════════════════
// MATH
// ═══════════════════════════════════════════════════════════════════════
const pDec = (v) => v >= 1 ? 2 : v >= 0.01 ? 4 : 6;
const fmt$ = (n,d) => '$'+n.toFixed(d !== undefined ? d : pDec(n));
const fmtM = n => n>=1e6?'$'+(n/1e6).toFixed(1)+'M':n>=1e3?'$'+(n/1e3).toFixed(0)+'K':fmt$(n,2);
const fmtBurn = n => n>=1e6?'$'+(n/1e6).toFixed(1)+'M':n>=1e3?'$'+(n/1e3).toFixed(0)+'K':'$'+n;

// ═══════════════════════════════════════════════════════════════════════
// LIVE DATA FETCHERS
// ═══════════════════════════════════════════════════════════════════════
async function fetchOHLCV() {
  var candles = await fetchCandlesForTF('1D');
  return candles.length > 0 ? candles : null;
}

async function fetchFromAPI() {
  try {
    const res = await fetch(API_BASE_DASH + '/api/current?token=' + tokenKey);
    const data = await res.json();
    if (data.error) return false;
    if (data.spot > 0) CFG.spot = data.spot;
    if (data.treasuryUSDC > 0) CFG.treasuryUSDC = data.treasuryUSDC;
    if (data.effectiveSupply > 0) CFG.effectiveSupply = data.effectiveSupply;
    if (data.onChainSupply > 0) CFG.onChainSupply = data.onChainSupply;
    if (data.lockedTokens > 0) CFG.lockedTokenBalance = data.lockedTokens;
    if (data.ammTokens > 0) CFG.ammTokenBalance = data.ammTokens;
    console.log('API data:', data);
    return true;
  } catch (e) { console.warn('API fetch failed:', e.message); return false; }
}

// ═══════════════════════════════════════════════════════════════════════
// FALLBACK SIMULATED DATA
// ═══════════════════════════════════════════════════════════════════════
function genFallback() {
  const fb = CFG.fallback;
  const data = [];
  const tge = new Date(CFG.tge);
  const now = new Date();
  const days = Math.floor((now - tge) / 86400000);
  let price = fb.listPrice;
  let seed = 42;
  const rng = () => { seed = (seed * 16807) % 2147483647; return seed / 2147483647; };
  for (let d = 0; d <= days; d++) {
    const noise = (rng() - 0.48) * 0.025 * price;
    if (d < fb.peakDay) {
      price += (fb.listPrice + (fb.peakPrice-fb.listPrice)*(1-Math.pow(1-d/fb.peakDay,1.8)) - price) * 0.12 + noise;
    } else if (d < fb.bounceDay) {
      price += (fb.peakPrice + (fb.bouncePrice-fb.peakPrice)*Math.pow((d-fb.peakDay)/(fb.bounceDay-fb.peakDay),0.6) - price) * 0.06 + noise*0.8;
    } else {
      price += (fb.bouncePrice + (CFG.spot-fb.bouncePrice)*Math.pow((d-fb.bounceDay)/Math.max(days-fb.bounceDay,1),0.7) - price) * 0.04 + noise*0.6;
    }
    price = Math.max(fb.floor, price);
    if (d === days) price = CFG.spot;
    data.push({ date: new Date(tge.getTime() + d*86400000), price: parseFloat(price.toFixed(6)) });
  }
  return data;
}


// ═══════════════════════════════════════════════════════════════════════
// CHART — TradingView Lightweight Charts + NAV overlays
// ═══════════════════════════════════════════════════════════════════════
var _allCandles = {};
var _navPerToken = 0;
var _chartTF = '1D';
var _chartViewMode = 'nav'; // 'nav' (line) or 'candle'
var _tvChart = null;
var _tvSeries = null;
var _tvNavLine = null;
var _tvPctLines = [];

async function fetchCandlesForTF(tf) {
  if (_allCandles[tf]) return _allCandles[tf];
  if (!CFG.mint) return [];
  try {
    var tge = new Date(CFG.tge || '2025-01-01');
    var now = new Date();
    var birdeyeTF = { '12H': '12H', '1D': '1D', '1W': '1W', '1M': '1M' }[tf] || '1D';
    var url = 'https://public-api.birdeye.so/defi/ohlcv?address=' + CFG.mint + '&type=' + birdeyeTF + '&time_from=' + Math.floor(tge.getTime() / 1000) + '&time_to=' + Math.floor(now.getTime() / 1000);
    var resp = await fetch(url, { headers: { 'X-API-KEY': 'f570879c3c51419fb0c7e75e38793434' } });
    var json = await resp.json();
    if (!json.data || !json.data.items) return [];
    var candles = json.data.items.map(function(c) {
      return { date: new Date(c.unixTime * 1000), open: c.o, high: c.h, low: c.l, close: c.c, price: c.c };
    });
    _allCandles[tf] = candles;
    return candles;
  } catch (e) { return []; }
}

function candlesToTV(candles) {
  return candles.map(function(c) {
    return {
      time: Math.floor(c.date.getTime() / 1000),
      open: c.open || c.price,
      high: c.high || c.price,
      low: c.low || c.price,
      close: c.close || c.price
    };
  });
}

function candlesToTVLine(candles) {
  return candles.map(function(c) {
    return {
      time: Math.floor(c.date.getTime() / 1000),
      value: c.close || c.price
    };
  });
}

function removeNAVOverlays() {
  if (_tvNavLine && _tvSeries) {
    try { _tvSeries.removePriceLine(_tvNavLine); } catch(e) {}
    _tvNavLine = null;
  }
  _tvPctLines.forEach(function(pl) {
    try { _tvSeries.removePriceLine(pl); } catch(e) {}
  });
  _tvPctLines = [];
}

function addNAVOverlays(navPerToken) {
  if (!_tvSeries || !navPerToken) return;

  // NAV price line
  _tvNavLine = _tvSeries.createPriceLine({
    price: navPerToken,
    color: '#e84057',
    lineWidth: 2,
    lineStyle: 2, // dashed
    axisLabelVisible: true,
    title: 'NAV',
  });

  // Percentage reference lines (only in line mode)
  if (_chartViewMode === 'nav') {
    var pctSteps = [10, 20, 30, 40, 50, 60, 70, 80, 90];
    pctSteps.forEach(function(pct) {
      var belowLine = _tvSeries.createPriceLine({
        price: navPerToken * (1 - pct / 100),
        color: 'rgba(232,64,87,0.25)',
        lineWidth: 1,
        lineStyle: 1, // dotted
        axisLabelVisible: false,
        title: '-' + pct + '%',
      });
      _tvPctLines.push(belowLine);
      var aboveLine = _tvSeries.createPriceLine({
        price: navPerToken * (1 + pct / 100),
        color: 'rgba(0,229,160,0.25)',
        lineWidth: 1,
        lineStyle: 1,
        axisLabelVisible: false,
        title: '+' + pct + '%',
      });
      _tvPctLines.push(aboveLine);
    });
  }
}

function buildChart(candles, navPerToken) {
  var container = document.getElementById('chart-container');

  // Destroy previous chart instance BEFORE clearing container
  if (_tvChart) {
    try { _tvChart.remove(); } catch(e) {}
    _tvChart = null;
    _tvSeries = null;
    _tvNavLine = null;
    _tvPctLines = [];
  }

  container.innerHTML = '';

  if (!candles || candles.length === 0) {
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:12px;color:#555560">No chart data available</div>';
    return;
  }

  var chartWidth = Math.min(920, container.clientWidth);

  _tvChart = LightweightCharts.createChart(container, {
    width: chartWidth,
    height: 420,
    layout: {
      background: { type: 'solid', color: '#16161c' },
      textColor: '#555560',
      fontFamily: 'Inter, sans-serif',
      fontSize: 11,
    },
    grid: {
      vertLines: { color: 'rgba(34,34,40,0.6)' },
      horzLines: { color: 'rgba(34,34,40,0.6)' },
    },
    crosshair: {
      mode: 0,
      vertLine: { color: 'rgba(255,255,255,0.15)', labelBackgroundColor: '#2a2a32' },
      horzLine: { color: 'rgba(255,255,255,0.15)', labelBackgroundColor: '#2a2a32' },
    },
    rightPriceScale: {
      borderColor: '#24242c',
      scaleMargins: { top: 0.08, bottom: 0.08 },
    },
    timeScale: {
      borderColor: '#24242c',
      timeVisible: true,
      secondsVisible: false,
      rightOffset: 5,
    },
    handleScroll: { vertTouchDrag: true },
    handleScale: { axisPressedMouseMove: true },
  });

  var tvData = candlesToTV(candles);
  var tvLineData = candlesToTVLine(candles);

  if (_chartViewMode === 'candle') {
    _tvSeries = _tvChart.addCandlestickSeries({
      upColor: '#00e5a0',
      downColor: '#e84057',
      borderDownColor: '#e84057',
      borderUpColor: '#00e5a0',
      wickDownColor: 'rgba(232,64,87,0.5)',
      wickUpColor: 'rgba(0,229,160,0.5)',
    });
    _tvSeries.setData(tvData);
  } else {
    // Baseline series: green above NAV, red below NAV
    _tvSeries = _tvChart.addBaselineSeries({
      baseValue: { type: 'price', price: navPerToken },
      topLineColor: '#00e5a0',
      topFillColor1: 'rgba(0,229,160,0.18)',
      topFillColor2: 'rgba(0,229,160,0.02)',
      bottomLineColor: '#e84057',
      bottomFillColor1: 'rgba(232,64,87,0.02)',
      bottomFillColor2: 'rgba(232,64,87,0.18)',
      lineWidth: 2,
    });
    _tvSeries.setData(tvLineData);
  }

  addNAVOverlays(navPerToken);
  _tvChart.timeScale().fitContent();

  // Resize handler — only attach once
  if (!container._resizeObserver) {
    container._resizeObserver = new ResizeObserver(function() {
      var newW = Math.min(920, container.clientWidth);
      if (_tvChart) _tvChart.applyOptions({ width: newW });
    });
    container._resizeObserver.observe(container);
  }
}

function initChart(rawCandles, navPerToken) {
  _allCandles['1D'] = rawCandles;
  _navPerToken = navPerToken;
  _chartTF = '1D';

  buildChart(rawCandles, navPerToken);

  // View toggle + Timeframe buttons
  var controls = document.getElementById('chart-controls');
  if (controls) {
    controls.addEventListener('click', async function(e) {
      var btn = e.target.closest('.chart-btn');
      if (!btn) return;

      // View toggle (Line / Candle)
      if (btn.dataset.view) {
        document.querySelectorAll('#chart-view-toggle .chart-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        _chartViewMode = btn.dataset.view;
        var candles = _allCandles[_chartTF] || rawCandles;
        buildChart(candles, _navPerToken);
        return;
      }

      // Timeframe toggle
      if (btn.dataset.tf) {
        controls.querySelectorAll('[data-tf]').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        _chartTF = btn.dataset.tf;
        var candles = await fetchCandlesForTF(_chartTF);
        if (candles.length === 0) candles = rawCandles;
        buildChart(candles, _navPerToken);
        renderNAVStats(candles, _navPerToken);
      }
    });
  }
}

// ═══════════════════════════════════════════════════════════════════════
// RENDER UI
// ═══════════════════════════════════════════════════════════════════════
function renderUI(isLive) {
  const supplyForNAV = CFG.effectiveSupply || CFG.supply;
  const strike = CFG.treasuryUSDC / supplyForNAV;
  const itm = CFG.spot < strike;
  const monthsLeft = CFG.monthlyBurn > 0 ? Math.floor(CFG.treasuryUSDC / CFG.monthlyBurn) : '\u221e';
  const discPct = strike > 0 ? ((CFG.spot - strike) / strike * 100) : 0;
  const isDiscount = discPct < 0;

  document.getElementById('sub-line').innerHTML = CFG.pair + ' \u00b7 FUTARCHY CPMM \u00b7 <span class="data-tag">' + (isLive ? 'LIVE' : 'SNAPSHOT') + '</span>';
  document.getElementById('title').textContent = CFG.ticker + ' \u2014 ' + (itm ? 'Trading Below Treasury Floor' : 'Trading Above Treasury Floor');
  document.getElementById('desc').innerHTML =
    CFG.ticker + ' is trading at <b>' + fmt$(CFG.spot) + '</b>, ' + (itm ? 'below' : 'above') + ' the <b>' + fmt$(strike) + '</b> treasury floor (treasury/token). ' +
    'Token holders can vote for dissolution and claim their pro-rata share of the treasury. ' +
    (itm ? 'Currently trading at a <span class="hl-orange">' + Math.abs(discPct).toFixed(1) + '%</span> discount \u2014 each token is backed by more than its market price.' : '');

  document.getElementById('cards').innerHTML =
    '<div class="card"><div class="card-label">Treasury</div><div class="card-value" style="color:var(--green)">' + fmtM(CFG.treasuryUSDC) + '</div><div class="card-sub">' + fmtM(CFG.monthlyBurn) + '/mo burn</div></div>' +
    '<div class="card"><div class="card-label">Spot Price</div><div class="card-value" style="color:var(--white)">' + fmt$(CFG.spot) + '</div><div class="card-sub">current market price</div></div>' +
    '<div class="card"><div class="card-label">Backing / Token</div><div class="card-value" style="color:var(--white)">' + fmt$(strike) + '</div><div class="card-sub">treasury \u00f7 holder supply</div></div>' +
    '<div class="card"><div class="card-label">' + (isDiscount ? 'Discount' : 'Premium') + '</div><div class="card-value" style="color:' + (isDiscount ? 'var(--red)' : 'var(--green)') + '">' + (isDiscount ? Math.abs(discPct).toFixed(1) + '%' : '+' + discPct.toFixed(0) + '%') + '</div><div class="card-sub">' + (isDiscount ? 'below treasury floor' : 'above treasury floor') + '</div></div>' +
    '<div class="card"><div class="card-label">Runway</div><div class="card-value" style="color:var(--orange)">' + monthsLeft + ' mo</div><div class="card-sub">at current burn rate</div></div>';

  document.getElementById('params').innerHTML =
    '<span>Raise <b>' + fmtM(CFG.raise) + '</b></span>' +
    '<span>Supply <b>' + (supplyForNAV / 1e6).toFixed(1) + 'M</b></span>' +
    '<span>S\u2080 <b>' + fmt$(CFG.icoPrice) + '</b></span>' +
    '<span>NAV <span class="hl">' + fmt$(strike) + '</span></span>' +
    '<span>Spot now <span class="spot">' + fmt$(CFG.spot) + '</span></span>' +
    '<span>ATH <b>' + fmt$(CFG.ath) + '</b></span>' +
    '<span>Burn <b>' + fmtBurn(CFG.monthlyBurn) + '/mo</b></span>';

  document.getElementById('chart-label').innerHTML = CFG.ticker + ' Price History \u2014 <span style="color:#e84057">dashed line = NAV (treasury \u00f7 holder supply)</span>';
  document.getElementById('leg-spot-label').textContent = CFG.ticker + ' bullish';
  document.getElementById('leg-strike').textContent = fmt$(strike);

  return strike;
}

// ═══════════════════════════════════════════════════════════════════════
// NAV STATS BAR
// ═══════════════════════════════════════════════════════════════════════
function renderNAVStats(candles, navPerToken) {
  var bar = document.getElementById('nav-stats-bar');
  if (!bar || !candles || candles.length === 0 || !navPerToken) { if (bar) bar.innerHTML = ''; return; }

  var aboveDays = 0, belowDays = 0;
  var currentStreak = 0, currentAbove = false;
  var maxAboveStreak = 0, maxBelowStreak = 0;
  var tempAbove = 0, tempBelow = 0;
  var avgAbovePct = 0, avgBelowPct = 0;
  var abovePctSum = 0, belowPctSum = 0;

  for (var i = 0; i < candles.length; i++) {
    var p = candles[i].close || candles[i].price;
    var pct = (p - navPerToken) / navPerToken * 100;
    if (p >= navPerToken) {
      aboveDays++;
      abovePctSum += pct;
      tempAbove++;
      if (tempAbove > maxAboveStreak) maxAboveStreak = tempAbove;
      tempBelow = 0;
    } else {
      belowDays++;
      belowPctSum += Math.abs(pct);
      tempBelow++;
      if (tempBelow > maxBelowStreak) maxBelowStreak = tempBelow;
      tempAbove = 0;
    }
  }

  var total = aboveDays + belowDays;
  var abovePct = total > 0 ? (aboveDays / total * 100) : 0;
  var belowPct = total > 0 ? (belowDays / total * 100) : 0;
  var avgAbove = aboveDays > 0 ? (abovePctSum / aboveDays) : 0;
  var avgBelow = belowDays > 0 ? (belowPctSum / belowDays) : 0;

  // Current streak
  var lastP = candles[candles.length - 1].close || candles[candles.length - 1].price;
  var isAboveNow = lastP >= navPerToken;
  currentStreak = 0;
  for (var j = candles.length - 1; j >= 0; j--) {
    var jp = candles[j].close || candles[j].price;
    if ((jp >= navPerToken) === isAboveNow) currentStreak++;
    else break;
  }

  bar.innerHTML =
    '<div class="ns-item ns-above">' +
      '<div class="ns-label">Time Above NAV</div>' +
      '<div class="ns-value">' + abovePct.toFixed(1) + '%</div>' +
      '<div class="ns-sub">' + aboveDays + ' of ' + total + ' periods · avg +' + avgAbove.toFixed(1) + '%</div>' +
      '<div class="ns-progress"><div class="ns-progress-fill" style="width:' + abovePct + '%;background:#00e5a0"></div></div>' +
    '</div>' +
    '<div class="ns-item ns-below">' +
      '<div class="ns-label">Time Below NAV</div>' +
      '<div class="ns-value">' + belowPct.toFixed(1) + '%</div>' +
      '<div class="ns-sub">' + belowDays + ' of ' + total + ' periods · avg -' + avgBelow.toFixed(1) + '%</div>' +
      '<div class="ns-progress"><div class="ns-progress-fill" style="width:' + belowPct + '%;background:#e84057"></div></div>' +
    '</div>' +
    '<div class="ns-item ns-neutral">' +
      '<div class="ns-label">Current Streak</div>' +
      '<div class="ns-value" style="color:' + (isAboveNow ? '#00e5a0' : '#e84057') + '">' + currentStreak + ' periods</div>' +
      '<div class="ns-sub">' + (isAboveNow ? 'above' : 'below') + ' NAV · longest ' + (isAboveNow ? maxAboveStreak + ' above' : maxBelowStreak + ' below') + '</div>' +
    '</div>';
}

// ═══════════════════════════════════════════════════════════════════════
// ADDRESS SECTION
// ═══════════════════════════════════════════════════════════════════════
function renderAddresses() {
  const section = document.getElementById('addr-section');
  if (!section) return;
  const truncAddr = a => a.slice(0, 6) + '…' + a.slice(-4);
  const solscanType = (label) => label === 'Token CA' ? 'token' : 'account';
  const addrs = [];
  if (CFG.mint) addrs.push(['Token CA', CFG.mint]);
  if (CFG.daoWallet) addrs.push(['DAO Treasury', CFG.daoWallet]);
  if (CFG.ammWallet) addrs.push(['AMM Pool 1', CFG.ammWallet]);
  if (CFG.ammWallet2) addrs.push(['AMM Pool 2', CFG.ammWallet2]);
  if (CFG.lockWallet) addrs.push(['Lock Contract', CFG.lockWallet]);
  if (CFG.buybackWallet) addrs.push(['Buyback Wallet', CFG.buybackWallet]);

  section.innerHTML = '<div class="addr-title">On-Chain Addresses</div>' +
    addrs.map(function(a) {
      var label = a[0], addr = a[1];
      var type = solscanType(label);
      return '<div class="addr-row"><span class="addr-label">' + label + '</span><div class="addr-val">' +
        '<a href="https://solscan.io/' + type + '/' + addr + '" target="_blank">' + truncAddr(addr) + '</a>' +
        '<button class="addr-copy" onclick="navigator.clipboard.writeText(\'' + addr + '\');this.textContent=\'Copied!\';this.classList.add(\'copied\');setTimeout(function(){this.textContent=\'Copy\';this.classList.remove(\'copied\')}.bind(this),1500)">Copy</button>' +
        '</div></div>';
    }).join('');
}

// ═══════════════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════════════
(async function main() {
  if (!CFG.live) return;
  CFG.effectiveSupply = CFG.supply;
  var navPerToken = renderUI(false);
  renderAddresses();

  try {
    var results = await Promise.all([fetchOHLCV(), fetchFromAPI()]);
    var ohlcv = results[0], apiOk = results[1];
    var isLive = !!(ohlcv || apiOk);
    navPerToken = renderUI(isLive);

    var chartData = (ohlcv && ohlcv.length > 0) ? ohlcv : genFallback();

    if (apiOk && chartData.length > 0) {
      var lastCandle = chartData[chartData.length - 1];
      if (Math.abs(lastCandle.price - CFG.spot) > CFG.spot * 0.01) {
        chartData.push({ date: new Date(), open: lastCandle.price, high: Math.max(lastCandle.price, CFG.spot), low: Math.min(lastCandle.price, CFG.spot), close: CFG.spot, price: CFG.spot });
      }
    }

    var loadEl = document.getElementById('chart-loading');
    if (loadEl) loadEl.remove();
    initChart(chartData, navPerToken);
    renderNAVStats(chartData, navPerToken);

    if (!ohlcv) {
      var notice = document.createElement('div');
      notice.style.cssText = 'text-align:center;font-size:9px;color:#ff8c42;font-family:Inter,sans-serif;padding:6px 0';
      notice.textContent = '\u26a0 Chart API unreachable \u2014 showing simulated data.';
      var chartContainer = document.getElementById('chart-container');
      chartContainer.parentNode.insertBefore(notice, chartContainer.nextSibling);
    }

    console.log('NAVgator ' + CFG.ticker + ' | Live: ' + isLive + ' | OHLCV: ' + (ohlcv ? ohlcv.length + ' candles' : 'fallback') + ' | Spot: $' + CFG.spot + ' | Treasury: $' + CFG.treasuryUSDC.toLocaleString() + ' | EffSupply: ' + (CFG.effectiveSupply || CFG.supply).toLocaleString() + ' | NAV: $' + navPerToken.toFixed(6));
  } catch (err) {
    console.error('NAVgator init error:', err);
    var loadEl2 = document.getElementById('chart-loading');
    if (loadEl2) loadEl2.remove();
    initChart(genFallback(), navPerToken);
    var notice2 = document.createElement('div');
    notice2.style.cssText = 'text-align:center;font-size:9px;color:#e84057;font-family:Inter,sans-serif;padding:6px 0';
    notice2.textContent = '\u26a0 Error loading data \u2014 showing simulated chart.';
    var cc2 = document.getElementById('chart-container');
    cc2.parentNode.insertBefore(notice2, cc2.nextSibling);
  }
})();
} // end if (_hasToken)
</script>
</body>
</html>
